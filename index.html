<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHub Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SortableJS for drag-and-drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <style>
        /* Custom styles for dark mode */
        body {
            min-height: 100vh;
        }
        #combinedTaskList.hide-completed .completed-task {
            display: none;
        }
        .sortable-ghost {
            background-color: #4a5568; /* A gray color for the placeholder */
            opacity: 0.5;
        }
        /* Zen Mode Styles */
        body.zen-mode .dashboard-widget {
            display: none;
        }
        body.zen-mode .dashboard-widget[data-widget-id="tasks"], 
        body.zen-mode .dashboard-widget[data-widget-id="revision-session"], 
        body.zen-mode .dashboard-widget[data-widget-id="music"] {
            display: block;
        }
        body.zen-mode .dashboard-widget[data-widget-id="tasks"] #homeworkWidget > div:first-child {
            display: none; /* Hide task creation UI */
        }
        body.zen-mode #combinedTaskList > div:not(.border-green-500) {
            display: none; /* Hide non-active tasks */
        }
        body.zen-mode #combinedTaskList > .border-green-500 {
            padding: 1.5rem; /* Larger padding for active task */
        }
        body.zen-mode #combinedTaskList > .border-green-500 .font-medium {
            font-size: 1.25rem; /* Larger title for active task */
        }
        body.zen-mode .dashboard-widget[data-widget-id="revision-session"] #revisionTimerDisplay {
            font-size: 6rem; /* from 5xl to 8xl */
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Login Screen (shown when user is not authenticated) -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-8 text-white">StudyHub Dashboard</h1>
            <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center gap-2 mx-auto">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Login with Google
            </button>
        </div>
    </div>

    <!-- Dashboard (shown when user is authenticated) -->
    <div id="dashboard" class="hidden p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-6 flex items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">StudyHub Dashboard</h1>
                <p class="text-gray-400">Welcome back! Let's get productive.</p>
            </div>
            <div class="flex items-center gap-2">
                <button id="zenModeBtn" class="inline-flex items-center gap-2 rounded-lg border border-gray-700 bg-gray-800/80 px-3 py-2 text-sm font-semibold text-gray-200 shadow hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span id="zenModeBtnText">Zen Mode</span>
                </button>
                <button id="menuToggle" class="inline-flex items-center gap-2 rounded-lg border border-gray-700 bg-gray-800/80 px-3 py-2 text-sm font-semibold text-gray-200 shadow hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition">
                    <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round"/>
                    </svg>
                    Menu
                </button>
            </div>
        </header>

        <!-- Daily Goal Progress Bar -->
        <div id="dailyProgressContainer" class="mb-6">
            <div class="flex justify-between mb-1 text-sm font-medium text-gray-400">
                <span>Today's Goal (8 hours)</span>
                <span id="dailyProgressText">0h 0m / 8h 0m</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="dailyProgressBar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>


        <!-- Main Grid Layout -->
        <div id="mainGrid" class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
            <!-- Profile Widget moved to side panel -->

            <!-- Combined Tasks Widget (Left, spans 2 columns) -->
            <div data-widget-id="tasks" class="dashboard-widget bg-gray-800 rounded-lg shadow-md p-6 md:col-span-2">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-white">Tasks</h2>
                    <button id="toggleCompletedBtn" class="hidden rounded-lg border border-gray-700 bg-gray-800 px-3 py-1.5 text-xs font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600">
                        Show Completed
                    </button>
                </div>
                <div class="space-y-4" id="homeworkWidget">
                    <div>
                        <div class="flex gap-2 mb-3">
                            <button class="px-3 py-1 text-sm font-medium rounded transition task-tab bg-gray-700 text-white border border-gray-600" data-tab-group="homework" data-tab="quick">
                                Quick Add
                            </button>
                            <button class="px-3 py-1 text-sm font-medium rounded transition task-tab bg-gray-800 text-gray-300 border border-transparent hover:bg-gray-700/70" data-tab-group="homework" data-tab="advanced">
                                Advanced Options
                            </button>
                        </div>
                        <div class="flex flex-col gap-2 md:flex-row">
                            <input type="text" id="homeworkInput" placeholder="Add homework task..." class="flex-1 bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 focus:outline-none focus:border-blue-500">
                            <button id="addHomeworkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 md:self-stretch">
                                Add
                            </button>
                        </div>
                        <div id="homeworkAdvancedOptions" class="hidden mt-3 space-y-4 rounded-xl border border-gray-700/60 bg-gray-800/70 p-4">
                            <div>
                                <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-400">Quick due dates</p>
                                <div class="flex flex-wrap gap-2">
                                    <button class="rounded-full border border-gray-600 bg-gray-700 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-quick-homework-due="today">
                                        Today
                                    </button>
                                    <button class="rounded-full border border-gray-600 bg-gray-700 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-quick-homework-due="tomorrow">
                                        Tomorrow
                                    </button>
                                    <button class="rounded-full border border-gray-600 bg-gray-700 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-quick-homework-due="week">
                                        Next week
                                    </button>
                                    <button class="rounded-full border border-gray-600 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-400 hover:border-red-500 hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-500" data-quick-homework-due="clear">
                                        Clear date
                                    </button>
                                </div>
                            </div>
                            <div class="rounded-lg border border-gray-700 bg-gray-900/40 p-3">
                                <p class="mb-1 text-xs font-semibold uppercase tracking-wide text-gray-500">Current settings</p>
                                <div id="homeworkSettingsSummary" class="text-sm text-gray-300">No due date • Color: None • Priority: Medium</div>
                            </div>
                            <div class="rounded-lg border border-gray-700 bg-gray-900/40 p-3">
                                <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-500">Tags</p>
                                <div id="homeworkTagsPicker" class="flex flex-wrap gap-2"></div>
                                <p class="mt-1 text-xs text-gray-500">Manage tags in the side panel → Tags.</p>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button id="homeworkPlannerBtn" class="inline-flex items-center gap-2 rounded-lg border border-blue-500/60 bg-blue-600/20 px-3 py-2 text-sm font-semibold text-blue-200 hover:bg-blue-600/30 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <path d="M8 7h8M8 11h4M5 5h14a2 2 0 0 1 2 2v12l-4-3-4 3-4-3-4 3V7a2 2 0 0 1 2-2z" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Open planner
                                </button>
                                <button id="homeworkClearSettingsBtn" class="inline-flex items-center gap-2 rounded-lg border border-gray-600 bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    Reset settings
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Combined Task List -->
                    <div id="combinedTaskList" class="space-y-3 max-h-[38rem] overflow-y-auto"></div>
                </div>
            </div>

            <!-- Calendar Widget (Right column) -->
            <div data-widget-id="calendar" class="dashboard-widget bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Google Calendar</h2>
                <div class="space-y-3">
                    <button id="connectCalendarBtn" class="w-full rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        Connect Google Calendar
                    </button>
                    <div id="calendarStatus" class="text-xs text-gray-400"></div>
                    <div id="upcomingEvents" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-sm text-gray-400">Connect to see your upcoming events.</p>
                    </div>
                </div>
            </div>

            <!-- Friends' Activity Widget -->
            <div data-widget-id="friends-activity" class="dashboard-widget bg-gray-800 rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-white">Friends' Activity</h2>
                    <button id="toggleFriendsCompletedBtn" class="hidden rounded-lg border border-gray-700 bg-gray-800 px-3 py-1.5 text-xs font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600">
                        Show Completed
                    </button>
                </div>
                <div id="friendsActivity" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-sm text-gray-400">No activity to show. Add friends to see their progress!</p>
                </div>
            </div>

            <!-- Study Timer Widget -->
            <div data-widget-id="study-timer" class="dashboard-widget bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Study Timer</h2>
                <div class="text-center space-y-4">
                    <div id="timerDisplay" class="text-5xl font-mono font-bold text-blue-400">25:00</div>
                    <div class="flex gap-2 justify-center">
                        <button id="timerStartBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Start
                        </button>
                        <button id="timerPauseBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Pause
                        </button>
                        <button id="timerResetBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Reset
                        </button>
                    </div>
                    <p id="timerStatus" class="text-sm text-gray-400">Ready to start</p>
                </div>
            </div>

            <!-- Music Widget -->
            <div data-widget-id="music" class="dashboard-widget bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Music</h2>
                <div class="aspect-video bg-gray-700 rounded overflow-hidden">
                    <iframe id="musicFrame" src="" class="w-full h-full border-0" allow="autoplay"></iframe>
                    <p class="text-sm text-gray-400 p-4 text-center">Add your Spotify/YouTube playlist embed URL</p>
                </div>
            </div>

            <!-- Revision Session Widget -->
            <div id="revisionSessionWidget" data-widget-id="revision-session" class="dashboard-widget bg-gray-800 rounded-lg shadow-md p-6 transition-all duration-500 ease-in-out">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-white">Revision Session</h2>
                    <button id="toggleRevisionWidgetSizeBtn" class="p-2 rounded-full text-gray-400 hover:bg-gray-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-gray-600" title="Expand">
                        <svg id="expandIcon" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M 4 8 V 4 m 0 0 h 4 M 4 4 l 5 5 Z M 4 16 v 4 m 0 0 h 4 m -4 0 l 5 -5 m 10 -7 v -4 m 0 0 h -4 m 4 0 l -5 5 M 15 20 h 4 M 19 20 V 16 M 19 20 L 14 15" /></svg>
                        <svg id="collapseIcon" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                </div>
                <div id="revisionSessionCompactView">
                    <div class="text-center space-y-4">
                        <div id="revisionTimerDisplay" class="text-5xl font-mono font-bold text-purple-400">00:00:00</div>
                        <div class="flex gap-2 justify-center">
                            <button id="revisionStartBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                                Start
                            </button>
                            <button id="revisionPauseBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-200 hidden">
                                Pause
                            </button>
                            <button id="revisionStopBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-200 hidden">
                                Stop & Save
                            </button>
                        </div>
                        <p id="revisionTimerStatus" class="text-sm text-gray-400">Ready to start a revision session.</p>
                    </div>
                </div>
                <div id="revisionSessionExpandedView" class="hidden mt-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Today's Stats -->
                        <div class="space-y-3 text-center md:text-left">
                            <h3 class="font-semibold text-white">Today's Progress</h3>
                            <p class="text-3xl font-bold text-blue-300" id="totalStudyTimeToday">0h 0m</p>
                            <div id="encouragementMessage" class="text-sm text-gray-400 h-10">Keep going! Every minute counts.</div>
                        </div>
                        <!-- Leaderboard -->
                        <div id="leaderboardContainer">
                            <div class="border-t border-gray-700 md:border-t-0 md:border-l md:pl-6 md:border-gray-700">
                                <div class="flex gap-2 mb-3">
                                    <button class="px-3 py-1 text-sm font-medium rounded transition leaderboard-tab bg-gray-700 text-white border border-gray-600" data-leaderboard-tab="today">Today</s-button>
                                    <button class="px-3 py-1 text-sm font-medium rounded transition leaderboard-tab bg-gray-800 text-gray-300 border border-transparent hover:bg-gray-700/70" data-leaderboard-tab="weekly">This Week</button>
                                </div>
                                <div id="leaderboardToday" class="space-y-2">
                                    <!-- Leaderboard content will be injected here -->
                                </div>
                                <div id="leaderboardWeekly" class="hidden space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div id="sidePanelOverlay" class="fixed inset-0 z-40 hidden bg-black/70 backdrop-blur-sm"></div>
    <aside id="sidePanel" class="fixed inset-y-0 right-0 z-50 w-full max-w-md translate-x-full transform border-l border-gray-800 bg-gray-900/95 shadow-2xl transition-transform duration-300 ease-in-out lg:max-w-sm">
        <div class="flex h-full flex-col">
            <div class="flex items-center justify-between border-b border-gray-800 px-5 py-4">
                <div>
                    <p class="text-xs uppercase tracking-wide text-gray-500">Quick Actions</p>
                    <h2 class="text-lg font-semibold text-white">Control Center</h2>
                </div>
                <button id="sidePanelCloseBtn" class="rounded-full border border-gray-700 bg-gray-800/70 p-2 text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M6 6l12 12M6 18L18 6" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="border-b border-gray-800 px-5 py-3">
                <div class="flex gap-2">
                    <button class="side-panel-tab rounded-lg border border-blue-500/60 bg-blue-600/20 px-3 py-2 text-sm font-semibold text-blue-200 hover:bg-blue-600/30 focus:outline-none focus:ring-2 focus:ring-blue-500" data-side-panel-tab="friends">
                        Friends
                    </button>
                    <button class="side-panel-tab rounded-lg border border-transparent bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" data-side-panel-tab="music">
                        Music Links
                    </button>
                    <button class="side-panel-tab rounded-lg border border-transparent bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" data-side-panel-tab="profile">
                        Profile
                    </button>
                    <button class="side-panel-tab rounded-lg border border-transparent bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" data-side-panel-tab="tags">
                        Tags
                    </button>
                    <button class="side-panel-tab rounded-lg border border-transparent bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" data-side-panel-tab="settings">
                        Settings
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-5 pb-6">
                <div data-side-panel-section="friends" class="space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-2 text-sm font-semibold text-white">Add a friend</h3>
                        <div class="flex gap-2">
                            <input type="text" id="friendInput" placeholder="Friend's User ID..." class="flex-1 rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="addFriendBtn" class="rounded-lg bg-purple-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-400">
                                Add
                            </button>
                        </div>
                        <p class="mt-2 text-xs text-gray-400">Share your User ID to connect with classmates.</p>
                    </div>
                    <div class="rounded-xl border border-gray-800 bg-gray-800/40 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Friends list</h3>
                        <div id="friendsList" class="space-y-2 max-h-80 overflow-y-auto pr-1">
                            <p class="text-sm text-gray-400">No friends yet. Add a friend by their User ID!</p>
                        </div>
                    </div>
                </div>
                <div data-side-panel-section="music" class="hidden space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-2 text-sm font-semibold text-white">Music links</h3>
                        <p class="mb-3 text-xs text-gray-400">Save playlists or lo-fi streams to launch them quickly. Links are stored locally on this device.</p>
                        <div class="flex gap-2">
                            <input type="url" id="musicLinkInput" placeholder="https://open.spotify.com/..." class="flex-1 rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <button id="addMusicLinkBtn" class="rounded-lg bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                Save
                            </button>
                        </div>
                    </div>
                    <div class="rounded-xl border border-gray-800 bg-gray-800/40 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Saved links</h3>
                        <ul id="musicLinksList" class="space-y-2 text-sm text-gray-200"></ul>
                        <p id="musicLinksEmptyState" class="text-xs text-gray-500">No links yet. Add your favorite playlists above.</p>
                    </div>
                </div>
                <div data-side-panel-section="profile" class="hidden space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Your profile</h3>
                        <div id="profileContent" class="space-y-4">
                            <div class="flex items-center gap-4">
                                <img id="userPhoto" src="" alt="User" class="h-16 w-16 rounded-full border-2 border-gray-600 object-cover">
                                <div>
                                    <p id="userName" class="font-semibold text-white"></p>
                                    <p id="userEmail" class="text-sm text-gray-400"></p>
                                </div>
                            </div>
                            <div class="rounded-lg border border-gray-700 bg-gray-900/40 p-3">
                                <p class="text-xs uppercase tracking-wide text-gray-400">User ID</p>
                                <p id="userId" class="mt-1 break-all rounded bg-gray-800 p-2 font-mono text-xs text-gray-300"></p>
                            </div>
                            <button id="signOutBtn" class="w-full rounded-lg bg-red-600 px-4 py-2 font-semibold text-white shadow hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-red-400">
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
                <div data-side-panel-section="tags" class="hidden space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-2 text-sm font-semibold text-white">Create a tag</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <input type="text" id="newTagName" placeholder="Tag name (e.g., Math)" class="sm:col-span-2 rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="newTagColor" class="rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="red">Red</option>
                                <option value="yellow">Yellow</option>
                                <option value="purple">Purple</option>
                                <option value="teal">Teal</option>
                            </select>
                        </div>
                        <div class="mt-2">
                            <button id="addTagBtn" class="rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400">Add tag</button>
                        </div>
                    </div>
                    <div class="rounded-xl border border-gray-800 bg-gray-800/40 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Your tags</h3>
                        <div id="tagList" class="flex flex-wrap gap-2"></div>
                        <p id="tagListEmpty" class="text-xs text-gray-500">No tags yet. Create one above.</p>
                    </div>
                </div>
                <div data-side-panel-section="settings" class="hidden space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Dashboard Layout</h3>
                        <p class="mb-3 text-xs text-gray-400">Enable re-order mode to drag and drop widgets into your preferred layout.</p>
                        <button id="toggleReorderBtn" class="w-full rounded-lg bg-indigo-600 px-4 py-2 font-semibold text-white shadow hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-400">
                            Enable Re-order Mode
                        </button>
                        <p id="reorderStatus" class="mt-2 text-center text-xs text-green-400 hidden">Re-order mode is active. Drag widgets to move them.</p>
                    </div>
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Widget Visibility</h3>
                        <p class="mb-3 text-xs text-gray-400">Toggle which widgets are displayed on your dashboard.</p>
                        <div id="widgetVisibilityList" class="space-y-2">
                            <!-- Checkboxes will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Task Planner Modal -->
    <div id="taskPlannerModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-2xl rounded-2xl border border-gray-800 bg-gray-900/95 shadow-2xl">
            <div class="flex items-start justify-between border-b border-gray-800 px-6 py-4">
                <div>
                    <p id="plannerSubtitle" class="text-xs uppercase tracking-wide text-gray-500">Plan task</p>
                    <h3 id="plannerTitle" class="text-xl font-semibold text-white">Task planner</h3>
                </div>
                <button id="plannerCloseBtn" class="rounded-full border border-gray-700 bg-gray-800/70 p-2 text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M6 6l12 12M6 18L18 6" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="grid gap-6 px-6 py-6 md:grid-cols-2">
                <div class="space-y-4">
                    <div>
                        <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-400">Due date</p>
                        <input type="date" id="plannerDueDate" class="w-full rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button class="rounded-full border border-gray-700 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-planner-quick="today">Today</button>
                            <button class="rounded-full border border-gray-700 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-planner-quick="tomorrow">Tomorrow</button>
                            <button class="rounded-full border border-gray-700 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-planner-quick="week">Next week</button>
                            <button class="rounded-full border border-gray-700 bg-gray-900 px-3 py-1 text-xs font-medium text-gray-400 hover:border-red-500 hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-500" data-planner-quick="clear">Clear</button>
                        </div>
                    </div>
                    <div>
                        <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-400">Notes</p>
                        <textarea id="plannerNotes" rows="5" placeholder="Add context, study materials or links..." class="w-full rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
                <div class="space-y-5">
                    <div>
                        <p class="mb-3 text-xs font-semibold uppercase tracking-wide text-gray-400">Color tag</p>
                        <div class="grid grid-cols-3 gap-2" id="plannerColorOptions">
                            <button class="planner-color-option rounded-lg border border-gray-700 bg-gray-900/60 px-3 py-2 text-sm font-medium text-gray-300 hover:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" data-color="none">No color</button>
                            <button class="planner-color-option rounded-lg border border-blue-500/40 bg-blue-600/20 px-3 py-2 text-sm font-medium text-blue-100 hover:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400" data-color="blue">Blue</button>
                            <button class="planner-color-option rounded-lg border border-emerald-500/40 bg-emerald-600/20 px-3 py-2 text-sm font-medium text-emerald-100 hover:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-400" data-color="green">Green</button>
                            <button class="planner-color-option rounded-lg border border-rose-500/40 bg-rose-600/20 px-3 py-2 text-sm font-medium text-rose-100 hover:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-400" data-color="red">Red</button>
                            <button class="planner-color-option rounded-lg border border-amber-500/40 bg-amber-500/20 px-3 py-2 text-sm font-medium text-amber-100 hover:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-400" data-color="yellow">Yellow</button>
                            <button class="planner-color-option rounded-lg border border-purple-500/40 bg-purple-600/20 px-3 py-2 text-sm font-medium text-purple-100 hover:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-400" data-color="purple">Purple</button>
                            <button class="planner-color-option rounded-lg border border-cyan-500/40 bg-cyan-600/20 px-3 py-2 text-sm font-medium text-cyan-100 hover:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-400" data-color="teal">Teal</button>
                        </div>
                    </div>
                    <div>
                        <p class="mb-3 text-xs font-semibold uppercase tracking-wide text-gray-400">Priority</p>
                        <div class="flex flex-col gap-2" id="plannerPriorityOptions">
                            <button class="planner-priority-option flex items-center justify-between rounded-lg border border-rose-500/40 bg-rose-600/20 px-3 py-2 text-sm font-semibold text-rose-100 hover:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-400" data-priority="high">
                                <span>High</span>
                                <span class="text-xs uppercase tracking-wide">Focus now</span>
                            </button>
                            <button class="planner-priority-option flex items-center justify-between rounded-lg border border-amber-500/40 bg-amber-500/20 px-3 py-2 text-sm font-semibold text-amber-100 hover:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-400" data-priority="medium">
                                <span>Medium</span>
                                <span class="text-xs uppercase tracking-wide">Next up</span>
                            </button>
                            <button class="planner-priority-option flex items-center justify-between rounded-lg border border-emerald-500/40 bg-emerald-600/20 px-3 py-2 text-sm font-semibold text-emerald-100 hover:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-400" data-priority="low">
                                <span>Low</span>
                                <span class="text-xs uppercase tracking-wide">When ready</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between border-t border-gray-800 bg-gray-900/80 px-6 py-4">
                <div class="text-xs text-gray-500" id="plannerStatusMessage"></div>
                <div class="flex gap-2">
                    <button id="plannerCancelBtn" class="rounded-lg border border-gray-700 bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600">
                        Cancel
                    </button>
                    <button id="plannerSaveBtn" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Edit Modal -->
    <div id="tagEditModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-md rounded-2xl border border-gray-800 bg-gray-900/95 shadow-2xl">
            <div class="flex items-start justify-between border-b border-gray-800 px-6 py-4">
                <div>
                    <h3 class="text-xl font-semibold text-white">Edit Tag</h3>
                </div>
                <button id="tagEditCloseBtn" class="rounded-full border border-gray-700 bg-gray-800/70 p-2 text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M6 6l12 12M6 18L18 6" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="space-y-4 p-6">
                <input type="text" id="tagEditName" placeholder="Tag name" class="w-full rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="tagEditColor" class="w-full rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="blue">Blue</option>
                    <option value="green">Green</option>
                    <option value="red">Red</option>
                    <option value="yellow">Yellow</option>
                    <option value="purple">Purple</option>
                    <option value="teal">Teal</option>
                </select>
            </div>
            <div class="flex items-center justify-end gap-2 border-t border-gray-800 bg-gray-900/80 px-6 py-4">
                <button id="tagEditCancelBtn" class="rounded-lg border border-gray-700 bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600">Cancel</button>
                <button id="tagEditSaveBtn" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Homework Exercise Modal -->
    <div id="exerciseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Add Exercises</h3>
                <button id="closeExerciseModal" class="text-gray-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="exerciseInput" placeholder="Exercise name..." class="flex-1 bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 focus:outline-none focus:border-blue-500">
                    <button id="addExerciseBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                        Add
                    </button>
                </div>
                <div id="exerciseList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                <button id="saveExercisesBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                    Save Exercises
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-5 right-5 z-[100] w-full max-w-sm space-y-3">
        <!-- Toast notifications will be dynamically added here -->
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, getDoc, setDoc, serverTimestamp, arrayUnion, arrayRemove, orderBy, limit, writeBatch, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // TODO: Replace with your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBpZlB5V3ZIC4snTND51JBqPJlEzsvWpKs",
            authDomain: "study-dashboard-71a54.firebaseapp.com",
            projectId: "study-dashboard-71a54",
            storageBucket: "study-dashboard-71a54.firebasestorage.app",
            messagingSenderId: "92963704725",
            appId: "1:92963704725:web:5f8b09216e09862fb3b09c"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('loginBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhoto = document.getElementById('userPhoto');
        const userId = document.getElementById('userId');

        // Homework elements
        const homeworkInput = document.getElementById('homeworkInput');
        const addHomeworkBtn = document.getElementById('addHomeworkBtn');
        const homeworkList = document.getElementById('homeworkList');
        const homeworkAdvancedOptions = document.getElementById('homeworkAdvancedOptions');
        const homeworkSettingsSummary = document.getElementById('homeworkSettingsSummary');
        const homeworkPlannerBtn = document.getElementById('homeworkPlannerBtn');
        const homeworkClearSettingsBtn = document.getElementById('homeworkClearSettingsBtn');
        const homeworkQuickDueButtons = document.querySelectorAll('[data-quick-homework-due]');

        // Friends elements
        const friendInput = document.getElementById('friendInput');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const friendsList = document.getElementById('friendsList');

        // Friends' Activity elements
        const friendsActivity = document.getElementById('friendsActivity');
        const toggleFriendsCompletedBtn = document.getElementById('toggleFriendsCompletedBtn');
        const combinedTaskList = document.getElementById('combinedTaskList');

        // Side panel elements
        const menuToggle = document.getElementById('menuToggle');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');
        const sidePanelCloseBtn = document.getElementById('sidePanelCloseBtn');
        const sidePanelTabButtons = document.querySelectorAll('[data-side-panel-tab]');
        const sidePanelSections = document.querySelectorAll('[data-side-panel-section]');

        // Music links elements
        const musicLinkInput = document.getElementById('musicLinkInput');
        const addMusicLinkBtn = document.getElementById('addMusicLinkBtn');
        const musicLinksList = document.getElementById('musicLinksList');
        const musicFrame = document.getElementById('musicFrame');
        const musicLinksEmptyState = document.getElementById('musicLinksEmptyState');

        // Tags elements
        const newTagName = document.getElementById('newTagName');
        const newTagColor = document.getElementById('newTagColor');
        const addTagBtn = document.getElementById('addTagBtn');
        const tagList = document.getElementById('tagList');
        const tagListEmpty = document.getElementById('tagListEmpty');
        const homeworkTagsPicker = document.getElementById('homeworkTagsPicker');

        // Timer elements
        const timerDisplay = document.getElementById('timerDisplay');
        const timerStartBtn = document.getElementById('timerStartBtn');
        const timerPauseBtn = document.getElementById('timerPauseBtn');
        const timerResetBtn = document.getElementById('timerResetBtn');
        const timerStatus = document.getElementById('timerStatus');

        // Exercise Modal elements
        const exerciseModal = document.getElementById('exerciseModal');
        const exerciseInput = document.getElementById('exerciseInput');
        const addExerciseBtn = document.getElementById('addExerciseBtn');
        const exerciseList = document.getElementById('exerciseList');
        const saveExercisesBtn = document.getElementById('saveExercisesBtn');
        const closeExerciseModal = document.getElementById('closeExerciseModal');

        // Task planner modal elements
        const taskPlannerModal = document.getElementById('taskPlannerModal');
        const plannerTitle = document.getElementById('plannerTitle');
        const plannerSubtitle = document.getElementById('plannerSubtitle');
        const plannerDueDate = document.getElementById('plannerDueDate');
        const plannerNotes = document.getElementById('plannerNotes');
        const plannerColorOptions = document.querySelectorAll('.planner-color-option');
        const plannerPriorityOptions = document.querySelectorAll('.planner-priority-option');
        const plannerQuickButtons = document.querySelectorAll('[data-planner-quick]');
        const plannerStatusMessage = document.getElementById('plannerStatusMessage');
        const plannerSaveBtn = document.getElementById('plannerSaveBtn');
        const plannerCancelBtn = document.getElementById('plannerCancelBtn');
        const plannerCloseBtn = document.getElementById('plannerCloseBtn');

        // Task list controls
        const toggleCompletedBtn = document.getElementById('toggleCompletedBtn');

        // Tag edit modal elements
        const tagEditModal = document.getElementById('tagEditModal');
        const tagEditName = document.getElementById('tagEditName');
        const tagEditColor = document.getElementById('tagEditColor');
        const tagEditSaveBtn = document.getElementById('tagEditSaveBtn');
        const tagEditCancelBtn = document.getElementById('tagEditCancelBtn');
        const tagEditCloseBtn = document.getElementById('tagEditCloseBtn');

        // Calendar integration
        let googleAccessToken = null;
        const connectCalendarBtn = document.getElementById('connectCalendarBtn');
        const calendarStatus = document.getElementById('calendarStatus');
        const upcomingEvents = document.getElementById('upcomingEvents');

        // Revision Session elements
        const revisionTimerDisplay = document.getElementById('revisionTimerDisplay');
        const revisionStartBtn = document.getElementById('revisionStartBtn');
        const revisionPauseBtn = document.getElementById('revisionPauseBtn');
        const revisionStopBtn = document.getElementById('revisionStopBtn');
        const revisionTimerStatus = document.getElementById('revisionTimerStatus');
        const totalStudyTimeToday = document.getElementById('totalStudyTimeToday');
        const encouragementMessage = document.getElementById('encouragementMessage');
        const toggleRevisionWidgetSizeBtn = document.getElementById('toggleRevisionWidgetSizeBtn');
        const revisionSessionWidget = document.getElementById('revisionSessionWidget');
        const revisionSessionExpandedView = document.getElementById('revisionSessionExpandedView');
        const expandIcon = document.getElementById('expandIcon');
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
        const leaderboardToday = document.getElementById('leaderboardToday');
        const leaderboardWeekly = document.getElementById('leaderboardWeekly');
        const dailyProgressContainer = document.getElementById('dailyProgressContainer');
        const dailyProgressBar = document.getElementById('dailyProgressBar');
        const dailyProgressText = document.getElementById('dailyProgressText');

        // Layout Re-order elements
        const mainGrid = document.getElementById('mainGrid');
        const toggleReorderBtn = document.getElementById('toggleReorderBtn');
        const reorderStatus = document.getElementById('reorderStatus');
        const widgetVisibilityList = document.getElementById('widgetVisibilityList');

        // Widget Management
        const ALL_WIDGETS = Array.from(document.querySelectorAll('.dashboard-widget'));

        // Zen Mode elements
        const zenModeBtn = document.getElementById('zenModeBtn');
        const zenModeBtnText = document.getElementById('zenModeBtnText');


        // ============================================
        // UTILITIES
        // ============================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');

            const icons = {
                success: `<svg class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
                error: `<svg class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
                info: `<svg class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>`
            };

            const colors = {
                success: 'bg-green-600 border-green-700',
                error: 'bg-red-600 border-red-700',
                info: 'bg-blue-600 border-blue-700'
            };

            toast.className = `flex items-center gap-3 w-full rounded-lg border p-4 text-sm font-semibold text-white shadow-lg transition-all duration-300 transform translate-y-4 opacity-0 ${colors[type] || colors.info}`;
            toast.innerHTML = `
                ${icons[type] || icons.info}
                <span>${message}</span>
            `;
            container.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            }, 10);

            // Animate out and remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        function formatDueDate(value) {
            if (!value) return null;

            let dateObj = null;

            if (typeof value === 'string') {
                const parsed = new Date(`${value}T00:00:00`);
                if (!isNaN(parsed)) {
                    dateObj = parsed;
                }
            } else if (value instanceof Date) {
                dateObj = value;
            } else if (value?.toDate) {
                dateObj = value.toDate();
            }

            if (!dateObj) return null;

            return dateObj.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        const colorBadgeStyles = {
            blue: { label: 'Blue Tag', bg: 'rgba(59, 130, 246, 0.15)', border: 'rgba(59, 130, 246, 0.35)', text: '#bfdbfe', dot: '#60a5fa' },
            green: { label: 'Green Tag', bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.35)', text: '#6ee7b7', dot: '#10b981' },
            red: { label: 'Red Tag', bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.35)', text: '#fca5a5', dot: '#ef4444' },
            yellow: { label: 'Yellow Tag', bg: 'rgba(234, 179, 8, 0.15)', border: 'rgba(234, 179, 8, 0.35)', text: '#fcd34d', dot: '#eab308' },
            purple: { label: 'Purple Tag', bg: 'rgba(168, 85, 247, 0.15)', border: 'rgba(168, 85, 247, 0.35)', text: '#d8b4fe', dot: '#a855f7' },
            teal: { label: 'Teal Tag', bg: 'rgba(13, 148, 136, 0.15)', border: 'rgba(13, 148, 136, 0.35)', text: '#5eead4', dot: '#0d9488' },
            default: { label: 'Tag', bg: 'rgba(75, 85, 99, 0.3)', border: 'rgba(75, 85, 99, 0.45)', text: '#d1d5db', dot: '#9ca3af' }
        };

        const priorityBadgeStyles = {
            high: { label: 'High Priority', bg: 'rgba(248, 113, 113, 0.15)', border: 'rgba(248, 113, 113, 0.35)', text: '#fca5a5' },
            medium: { label: 'Medium Priority', bg: 'rgba(251, 191, 36, 0.15)', border: 'rgba(251, 191, 36, 0.35)', text: '#fcd34d' },
            low: { label: 'Low Priority', bg: 'rgba(52, 211, 153, 0.15)', border: 'rgba(52, 211, 153, 0.35)', text: '#6ee7b7' }
        };

        function getColorBadge(color) {
            if (!color || color === 'none') return '';
            const style = colorBadgeStyles[color] || colorBadgeStyles.default;
            return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold border" style="background-color:${style.bg}; border-color:${style.border}; color:${style.text}">
                <span class="w-2 h-2 rounded-full" style="background-color:${style.dot};"></span>
                ${style.label}
            </span>`;
        }

        function getPriorityBadge(priority) {
            if (!priority) return '';
            const style = priorityBadgeStyles[priority] || priorityBadgeStyles.medium;
            return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold border" style="background-color:${style.bg}; border-color:${style.border}; color:${style.text}">
                ${style.label}
            </span>`;
        }

        function setupTabGroup(groupName, optionsContainer) {
            const buttons = Array.from(document.querySelectorAll(`[data-tab-group="${groupName}"]`));
            if (buttons.length === 0) return;

            const activeClasses = ['bg-gray-700', 'text-white', 'border-gray-600'];
            const inactiveClasses = ['bg-gray-800', 'text-gray-300', 'border-transparent'];

            const activate = (button) => {
                buttons.forEach((btn) => {
                    btn.classList.remove(...activeClasses, ...inactiveClasses);
                    btn.classList.add(...inactiveClasses);
                });

                button.classList.remove(...inactiveClasses);
                button.classList.add(...activeClasses);

                if (optionsContainer) {
                    if (button.dataset.tab === 'advanced') {
                        optionsContainer.classList.remove('hidden');
                    } else {
                        optionsContainer.classList.add('hidden');
                    }
                }
            };

            buttons.forEach((button) => {
                button.addEventListener('click', () => activate(button));
            });

            const defaultButton = buttons.find(btn => btn.dataset.tab === 'quick') || buttons[0];
            activate(defaultButton);
        }

        setupTabGroup('homework', homeworkAdvancedOptions);

        // ============================================
        // STATE HELPERS
        // ============================================
        const colorNames = {
            none: 'None',
            blue: 'Blue',
            green: 'Green',
            red: 'Red',
            yellow: 'Yellow',
            purple: 'Purple',
            teal: 'Teal'
        };

        const priorityNames = {
            high: 'High',
            medium: 'Medium',
            low: 'Low'
        };

        const defaultTaskSettings = () => ({
            dueDate: null,
            color: 'none',
            priority: 'medium',
            notes: '',
            tags: []
        });

        const taskComposerState = {
            homework: defaultTaskSettings(),
        };

        const settingsSummaries = {
            homework: homeworkSettingsSummary,
        };

        function updateTaskComposerSummary(type) {
            const settings = taskComposerState[type];
            if (!settings || !settingsSummaries[type]) return; // 'type' will always be 'homework' now

            const pieces = [];
            pieces.push(settings.dueDate ? `Due ${formatDueDate(settings.dueDate)}` : 'No due date');
            pieces.push(`Color: ${colorNames[settings.color] || 'Custom'}`);
            pieces.push(`Priority: ${priorityNames[settings.priority] || 'Medium'}`);

            if (settings.notes?.trim()) {
                pieces.push('Notes ready');
            }
            if (settings.tags?.length) {
                pieces.push(`${settings.tags.length} tag${settings.tags.length > 1 ? 's' : ''}`);
            }

            settingsSummaries[type].innerHTML = pieces.map(piece => `<span>${piece}</span>`).join(' • ');
        }

        function applyQuickDueDate(type, action) {
            const settings = taskComposerState[type];
            if (!settings) return;

            if (action === 'clear') {
                settings.dueDate = null;
            } else {
                const date = new Date();
                if (action === 'tomorrow') {
                    date.setDate(date.getDate() + 1);
                } else if (action === 'week') {
                    date.setDate(date.getDate() + 7);
                }
                settings.dueDate = date.toISOString().slice(0, 10);
            }

            updateTaskComposerSummary(type);
        }

        function resetTaskComposerSettings(type) {
            taskComposerState[type] = defaultTaskSettings();
            updateTaskComposerSummary(type);
        }

        updateTaskComposerSummary('homework');

        function bindQuickDueButtons(buttons, type) {
            buttons.forEach((button) => {
                button.addEventListener('click', () => {
                    const action = button.dataset.quickHomeworkDue;
                    if (!action) return;
                    applyQuickDueDate(type, action);
                });
            });
        }

        bindQuickDueButtons(homeworkQuickDueButtons, 'homework');

        // ============================================
        // TAGS MANAGEMENT
        // ============================================
        let userTags = [];

        function renderTagChip(tag, withRemove = false) {
            // Added an edit button
            const style = colorBadgeStyles[tag.color] || colorBadgeStyles.default;
            return `
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-semibold border" style="background-color:${style.bg}; border-color:${style.border}; color:${style.text}">
                    <span class="w-2 h-2 rounded-full" style="background-color:${style.dot};"></span>
                    <span class="mx-1">${tag.name}</span>
                    ${withRemove ? `<button class="rounded bg-transparent hover:text-blue-300" data-edit-tag="${tag.id}" title="Edit">✎</button>` : ''}
                    ${withRemove ? `<button class="rounded bg-transparent hover:text-red-300" data-remove-tag="${tag.id}" title="Remove">×</button>` : ''}
                </span>
            `;
        }

        function renderTagList() {
            if (!tagList) return;
            tagList.innerHTML = '';
            if (!userTags.length) {
                tagListEmpty.classList.remove('hidden');
                return;
            }
            tagListEmpty.classList.add('hidden');
            userTags.forEach(tag => {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = renderTagChip(tag, true);
                tagList.appendChild(wrapper.firstElementChild);
            });
        }

        function renderTagsPicker(container, type) {
            if (!container) return;
            container.innerHTML = '';
            userTags.forEach(tag => {
                const style = colorBadgeStyles[tag.color] || colorBadgeStyles.default;
                const isSelected = (taskComposerState[type].tags || []).some(t => t.id === tag.id);
                const el = document.createElement('button');
                el.className = `inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-semibold border transition-all ${isSelected ? 'ring-2 ring-offset-2 ring-offset-gray-800 ring-blue-400' : ''}`;
                el.setAttribute('style', `background-color:${style.bg}; border-color:${style.border}; color:${style.text}`);
                el.innerHTML = `<span class="w-2 h-2 rounded-full" style="background-color:${style.dot};"></span>${tag.name}`;
                el.addEventListener('click', () => {
                    const current = taskComposerState[type].tags || [];
                    const exists = current.some(t => t.id === tag.id);
                    taskComposerState[type].tags = exists
                        ? current.filter(t => t.id !== tag.id)
                        : [...current, tag]; // store full tag object to embed into task
                    renderTagsPicker(container, type);
                    updateTaskComposerSummary(type);
                });
                container.appendChild(el);
            });
            if (!userTags.length) {
                container.innerHTML = '<p class="text-xs text-gray-500">No tags yet.</p>';
            }
        }

        async function saveUserTags(tags) {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, { tags });
        }

        if (addTagBtn) {
            addTagBtn.addEventListener('click', async () => {
                const name = (newTagName?.value || '').trim();
                const color = newTagColor?.value || 'blue';
                if (!name || !currentUser) return;
                const id = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
                userTags.push({ id, name, color });
                renderTagList();
                renderTagsPicker(homeworkTagsPicker, 'homework'); // Only one picker to update now
                newTagName.value = '';
                try {
                    await saveUserTags(userTags);
                    showToast('Tag created successfully!');
                } catch (e) {
                    console.error('Failed to save tag:', e);
                }
            });
        }

        if (tagList) {
            tagList.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-remove-tag]');
                const editBtn = e.target.closest('[data-edit-tag]');
                if (editBtn) {
                    openTagEditModal(editBtn.dataset.editTag);
                    return;
                }
                if (!btn) return;
                const id = btn.getAttribute('data-remove-tag');
                userTags = userTags.filter(t => t.id !== id);
                renderTagList();
                renderTagsPicker(homeworkTagsPicker, 'homework'); // Only one picker to update now
                try {
                    await saveUserTags(userTags);
                    showToast('Tag removed.', 'info');
                } catch (e2) {
                    console.error('Failed to remove tag:', e2);
                    showToast('Failed to remove tag.', 'error');
                }
            });
        }

        // ============================================
        // TAG EDIT MODAL
        // ============================================
        let currentEditingTagId = null;

        function openTagEditModal(tagId) {
            currentEditingTagId = tagId;
            const tag = userTags.find(t => t.id === tagId);
            if (!tag || !tagEditModal) return;

            tagEditName.value = tag.name;
            tagEditColor.value = tag.color;

            tagEditModal.classList.remove('hidden');
            tagEditModal.classList.add('flex');
            lockScroll();
        }

        function closeTagEditModal() {
            if (!tagEditModal) return;
            tagEditModal.classList.add('hidden');
            tagEditModal.classList.remove('flex');
            currentEditingTagId = null;
            unlockScroll();
        }

        if (tagEditSaveBtn) {
            tagEditSaveBtn.addEventListener('click', async () => {
                if (!currentEditingTagId || !currentUser) return;

                const newName = tagEditName.value.trim();
                const newColor = tagEditColor.value;
                if (!newName) return;

                const tagIndex = userTags.findIndex(t => t.id === currentEditingTagId);
                if (tagIndex === -1) return;

                const oldTag = { ...userTags[tagIndex] };
                const newTag = { id: currentEditingTagId, name: newName, color: newColor };
                userTags[tagIndex] = newTag;

                // Save the updated tags array to the user's document
                await saveUserTags(userTags);

                // Now, find and update all tasks that use this tag
                const tasksQuery = query(collection(db, 'tasks'), where('userId', '==', currentUser.uid));
                const querySnapshot = await getDocs(tasksQuery);
                const batch = writeBatch(db);

                querySnapshot.forEach(docSnap => {
                    const task = { id: docSnap.id, ...docSnap.data() };
                    const taskTags = task.tags || [];
                    const tagToUpdateIndex = taskTags.findIndex(t => t.id === currentEditingTagId);

                    if (tagToUpdateIndex > -1) {
                        const updatedTaskTags = [...taskTags];
                        updatedTaskTags[tagToUpdateIndex] = newTag;
                        const taskRef = doc(db, 'tasks', task.id);
                        batch.update(taskRef, { tags: updatedTaskTags });
                    }
                });

                await batch.commit();

                // Re-render UI
                renderTagList();
                renderTagsPicker(homeworkTagsPicker, 'homework');
                showToast('Tag updated successfully!');
                closeTagEditModal();
            });
        }

        [tagEditCancelBtn, tagEditCloseBtn].forEach(btn => btn?.addEventListener('click', closeTagEditModal));

        if (homeworkPlannerBtn) {
            homeworkPlannerBtn.addEventListener('click', () => {
                openTaskPlanner({ mode: 'create', type: 'homework' });
            });
        }

        if (homeworkClearSettingsBtn) {
            homeworkClearSettingsBtn.addEventListener('click', () => resetTaskComposerSettings('homework'));
        }

        // ============================================
        // SCROLL LOCK MANAGEMENT
        // ============================================
        let overlayStack = 0;

        function lockScroll() {
            overlayStack += 1;
            document.body.classList.add('overflow-hidden');
        }

        function unlockScroll() {
            overlayStack = Math.max(overlayStack - 1, 0);
            if (overlayStack === 0) {
                document.body.classList.remove('overflow-hidden');
            }
        }

        // ============================================
        // SIDE PANEL
        // ============================================
        const sidePanelActiveClasses = ['border-blue-500/60', 'bg-blue-600/20', 'text-blue-200'];
        const sidePanelInactiveClasses = ['border-transparent', 'bg-gray-800', 'text-gray-300'];
        let isSidePanelOpen = false;

        function setSidePanelTab(tabName = 'friends') {
            sidePanelTabButtons.forEach((button) => {
                const isActive = button.dataset.sidePanelTab === tabName;
                button.classList.remove(...sidePanelActiveClasses, ...sidePanelInactiveClasses);
                button.classList.add(...(isActive ? sidePanelActiveClasses : sidePanelInactiveClasses));
            });

            sidePanelSections.forEach((section) => {
                section.classList.toggle('hidden', section.dataset.sidePanelSection !== tabName);
            });
        }

        function openSidePanel(defaultTab = 'friends') {
            if (!sidePanel || !sidePanelOverlay) return;
            setSidePanelTab(defaultTab);
            sidePanel.classList.remove('translate-x-full');
            sidePanelOverlay.classList.remove('hidden');
            isSidePanelOpen = true;
            lockScroll();
        }

        function closeSidePanel() {
            if (!sidePanel || !sidePanelOverlay || !isSidePanelOpen) return;
            sidePanel.classList.add('translate-x-full');
            sidePanelOverlay.classList.add('hidden');
            isSidePanelOpen = false;
            unlockScroll();
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', () => openSidePanel('friends'));
        }

        if (sidePanelCloseBtn) {
            sidePanelCloseBtn.addEventListener('click', closeSidePanel);
        }

        if (sidePanelOverlay) {
            sidePanelOverlay.addEventListener('click', closeSidePanel);
        }

        sidePanelTabButtons.forEach((button) => {
            button.addEventListener('click', () => setSidePanelTab(button.dataset.sidePanelTab));
        });

        setSidePanelTab('friends');

        // ============================================
        // MUSIC LINKS (LOCAL STORAGE)
        // ============================================
        const MUSIC_LINKS_STORAGE_KEY = 'studyhub_music_links';
        let musicLinks = [];

        function loadMusicLinks() {
            if (!musicLinksList) return;
            try {
                const stored = localStorage.getItem(MUSIC_LINKS_STORAGE_KEY);
                musicLinks = stored ? JSON.parse(stored) : [];
                if (!Array.isArray(musicLinks)) {
                    musicLinks = [];
                }
            } catch (error) {
                console.warn('Failed to load music links from storage:', error);
                musicLinks = [];
            }
        }

        function saveMusicLinks() {
            try {
                localStorage.setItem(MUSIC_LINKS_STORAGE_KEY, JSON.stringify(musicLinks));
            } catch (error) {
                console.warn('Failed to save music links:', error);
            }
        }

        function renderMusicLinks() {
            if (!musicLinksList || !musicLinksEmptyState) return;

            musicLinksList.innerHTML = '';
            if (musicLinks.length === 0) {
                musicLinksEmptyState.classList.remove('hidden');
                return;
            }

            musicLinksEmptyState.classList.add('hidden');

            musicLinks.forEach((link, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between gap-3 rounded-lg border border-gray-700 bg-gray-900/60 px-3 py-2';
                
                // Create a display name for the link
                let displayName = 'Unknown Link';
                try {
                    const url = new URL(link);
                    if (url.hostname.includes('spotify.com')) {
                        displayName = 'Spotify Playlist';
                    } else if (url.hostname.includes('youtube.com') || url.hostname.includes('youtu.be')) {
                        displayName = 'YouTube Video/Playlist';
                    } else {
                        displayName = url.hostname;
                    }
                } catch (e) { /* keep default name */ }

                li.innerHTML = `
                    <div class="flex-1 truncate">
                        <a href="#" data-play-music="${link}" class="font-medium text-blue-300 hover:text-blue-200 hover:underline">${displayName}</a>
                        <p class="text-xs text-gray-500 truncate">${link}</p>
                    </div>
                    <div class="flex-shrink-0 flex gap-1">
                        <button class="rounded-md border border-gray-600 bg-gray-800 p-1.5 text-xs font-semibold uppercase tracking-wide text-gray-300 hover:border-red-500 hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-500" data-remove-music="${index}" title="Remove">
                            <svg class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
                musicLinksList.appendChild(li);
            });
        }

        function getEmbedUrl(url) {
            if (url.includes('spotify.com/playlist/')) {
                return url.replace('spotify.com/playlist/', 'open.spotify.com/embed/playlist/');
            }
            if (url.includes('youtube.com/watch?v=')) {
                const videoId = new URL(url).searchParams.get('v');
                return `https://www.youtube.com/embed/${videoId}`;
            }
            // Assume it's already an embed link if it doesn't match
            return url;
        }

        function addMusicLink(url) {
            try {
                const parsed = new URL(url);
                if (!['http:', 'https:'].includes(parsed.protocol)) {
                    throw new Error('Invalid protocol');
                }
            } catch (error) {
                if (musicLinksEmptyState) {
                    musicLinksEmptyState.classList.remove('hidden');
                    musicLinksEmptyState.textContent = 'Please provide a valid https:// link.';
                }
                return false;
            }

            if (musicLinks.includes(url)) {
                if (musicLinksEmptyState) {
                    musicLinksEmptyState.classList.remove('hidden');
                    musicLinksEmptyState.textContent = 'Link already saved.';
                }
                return false;
            }

            musicLinks.push(url);
            saveMusicLinks();
            renderMusicLinks();
            if (musicLinksEmptyState) {
                musicLinksEmptyState.textContent = 'No links yet. Add your favorite playlists above.';
            }
            return true;
        }

        if (addMusicLinkBtn && musicLinkInput && musicLinksList) {
            addMusicLinkBtn.addEventListener('click', () => {
                const value = musicLinkInput.value.trim();
                if (!value) {
                    musicLinkInput.focus();
                    return;
                }
                if (addMusicLink(value)) {
                    musicLinkInput.value = '';
                }
            });

            musicLinkInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addMusicLinkBtn.click();
                }
            });

            musicLinksList.addEventListener('click', (event) => {
                const playBtn = event.target.closest('[data-play-music]');
                if (playBtn) {
                    event.preventDefault();
                    const url = playBtn.dataset.playMusic;
                    musicFrame.src = getEmbedUrl(url);
                }
                const button = event.target.closest('[data-remove-music]');
                if (!button) return;
                const index = parseInt(button.dataset.removeMusic, 10);
                if (Number.isNaN(index)) return;
                musicLinks.splice(index, 1);
                saveMusicLinks();
                renderMusicLinks();
                if (musicLinks.length === 0 && musicLinksEmptyState) {
                    musicLinksEmptyState.classList.remove('hidden');
                    musicLinksEmptyState.textContent = 'No links yet. Add your favorite playlists above.';
                }
            });

            loadMusicLinks();
            renderMusicLinks();
            // Load the first music link by default if it exists
            if (musicLinks.length > 0 && musicFrame) {
                musicFrame.src = getEmbedUrl(musicLinks[0]);
            }
        }

        // ============================================
        // TASK PLANNER MODAL
        // ============================================
        let plannerContext = null;
        let plannerDraft = null;

        function updatePlannerColorSelection(selected) {
            plannerColorOptions.forEach((button) => {
                const isActive = button.dataset.color === selected;
                button.classList.toggle('ring-2', isActive);
                button.classList.toggle('ring-offset-2', isActive);
                button.classList.toggle('ring-offset-gray-900', isActive);
                button.classList.toggle('ring-blue-400', isActive && selected === 'blue');
                button.classList.toggle('ring-emerald-400', isActive && selected === 'green');
                button.classList.toggle('ring-rose-400', isActive && selected === 'red');
                button.classList.toggle('ring-amber-400', isActive && selected === 'yellow');
                button.classList.toggle('ring-purple-400', isActive && selected === 'purple');
                button.classList.toggle('ring-cyan-400', isActive && selected === 'teal');
                if (selected === 'none' && isActive) {
                    button.classList.add('ring-gray-400');
                } else {
                    button.classList.remove('ring-gray-400');
                }
            });
        }

        function updatePlannerPrioritySelection(selected) {
            plannerPriorityOptions.forEach((button) => {
                const isActive = button.dataset.priority === selected;
                button.classList.toggle('ring-2', isActive);
                button.classList.toggle('ring-offset-2', isActive);
                button.classList.toggle('ring-offset-gray-900', isActive);
            });
        }

        function updatePlannerInputs() {
            if (!plannerDraft) return;
            plannerDueDate.value = plannerDraft.dueDate || '';
            plannerNotes.value = plannerDraft.notes || '';
            updatePlannerColorSelection(plannerDraft.color || 'none');
            updatePlannerPrioritySelection(plannerDraft.priority || 'medium');
            plannerStatusMessage.textContent = '';
            plannerSaveBtn.disabled = false;
        }

        function openTaskPlanner(context) {
            plannerContext = context;
            const baseSettings = context.mode === 'edit'
                ? {
                    dueDate: context.taskData?.dueDate || null,
                    color: context.taskData?.color || 'none',
                    priority: context.taskData?.priority || 'medium',
                    notes: context.taskData?.notes || ''
                }
                : { ...taskComposerState[context.type] };

            plannerDraft = {
                dueDate: baseSettings.dueDate || null,
                color: baseSettings.color || 'none',
                priority: baseSettings.priority || 'medium',
                notes: baseSettings.notes || ''
            };

            plannerTitle.textContent = context.mode === 'edit' ? 'Edit task details' : 'Task planner';
            plannerSubtitle.textContent = context.type === 'homework' ? 'Homework task' : 'Revision task';

            updatePlannerInputs();

            if (taskPlannerModal) {
                taskPlannerModal.classList.remove('hidden');
                taskPlannerModal.classList.add('flex');
                lockScroll();
            }
        }

        function closeTaskPlanner() {
            if (!plannerContext) return;
            plannerContext = null;
            plannerDraft = null;
            if (taskPlannerModal) {
                taskPlannerModal.classList.add('hidden');
                taskPlannerModal.classList.remove('flex');
                unlockScroll();
            }
        }

        if (plannerDueDate) {
            plannerDueDate.addEventListener('change', () => {
                if (!plannerDraft) return;
                plannerDraft.dueDate = plannerDueDate.value || null;
            });
        }

        if (plannerNotes) {
            plannerNotes.addEventListener('input', () => {
                if (!plannerDraft) return;
                plannerDraft.notes = plannerNotes.value;
            });
        }

        plannerColorOptions.forEach((button) => {
            button.addEventListener('click', () => {
                if (!plannerDraft) return;
                plannerDraft.color = button.dataset.color;
                updatePlannerColorSelection(plannerDraft.color);
            });
        });

        plannerPriorityOptions.forEach((button) => {
            button.addEventListener('click', () => {
                if (!plannerDraft) return;
                plannerDraft.priority = button.dataset.priority;
                updatePlannerPrioritySelection(plannerDraft.priority);
            });
        });

        plannerQuickButtons.forEach((button) => {
            button.addEventListener('click', () => {
                if (!plannerDraft) return;
                const action = button.dataset.plannerQuick;
                if (action === 'clear') {
                    plannerDraft.dueDate = null;
                } else {
                    const date = new Date();
                    if (action === 'tomorrow') {
                        date.setDate(date.getDate() + 1);
                    } else if (action === 'week') {
                        date.setDate(date.getDate() + 7);
                    }
                    plannerDraft.dueDate = date.toISOString().slice(0, 10);
                }
                updatePlannerInputs();
            });
        });

        if (plannerCancelBtn) {
            plannerCancelBtn.addEventListener('click', closeTaskPlanner);
        }

        if (plannerCloseBtn) {
            plannerCloseBtn.addEventListener('click', closeTaskPlanner);
        }

        if (taskPlannerModal) {
            taskPlannerModal.addEventListener('click', (event) => {
                if (event.target === taskPlannerModal) {
                    closeTaskPlanner();
                }
            });
        }

        if (plannerSaveBtn) {
            plannerSaveBtn.addEventListener('click', async () => {
                if (!plannerContext || !plannerDraft) return;

                const payload = {
                    dueDate: plannerDraft.dueDate || null,
                    color: plannerDraft.color === 'none' ? null : plannerDraft.color,
                    priority: plannerDraft.priority || 'medium',
                    notes: plannerDraft.notes?.trim() || ''
                };

                plannerSaveBtn.disabled = true;
                plannerStatusMessage.textContent = plannerContext.mode === 'edit' ? 'Saving changes…' : 'Updating defaults…';

                if (plannerContext.mode === 'edit') {
                    try {
                        const taskRef = doc(db, 'tasks', plannerContext.taskId);
                        await updateDoc(taskRef, payload);
                        plannerStatusMessage.textContent = 'Task updated.';
                        setTimeout(() => closeTaskPlanner(), 350);
                    } catch (error) {
                showToast('Failed to update task.', 'error');
                        console.error('Error updating task:', error);
                        plannerStatusMessage.textContent = 'Failed to update task. Please try again.';
                        plannerSaveBtn.disabled = false;
                    }
                } else {
                    const targetState = taskComposerState[plannerContext.type];
                    if (targetState) {
                        targetState.dueDate = payload.dueDate;
                        targetState.color = payload.color || 'none';
                        targetState.priority = payload.priority;
                        targetState.notes = payload.notes;
                        updateTaskComposerSummary(plannerContext.type);
                    }
                    plannerStatusMessage.textContent = 'Defaults updated.';
                    showToast('Default settings have been updated.', 'info');
                    setTimeout(() => closeTaskPlanner(), 250);
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (plannerContext) {
                    closeTaskPlanner();
                    return;
                }
                if (isSidePanelOpen) {
                    closeSidePanel();
                }
            }
        });

        // ============================================
        // AUTHENTICATION
        // ============================================
        let currentUser = null;
        let currentTaskId = null; // For exercise modal and other task-specific actions

        // Monitor authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                
                // Update profile
                userName.textContent = user.displayName || 'User';
                userEmail.textContent = user.email;
                userPhoto.src = user.photoURL || '';
                userId.textContent = user.uid;

                // Initialize user document in Firestore
                await initializeUserDocument(user);

                // Load all data
                loadAllTasks();
                loadWidgetVisibility();
                renderWidgetVisibilityControls();
                loadWidgetOrder();
                loadFriends();
                loadFriendsActivity();
                // Load tags
                const userRef = doc(db, 'users', currentUser.uid);
                onSnapshot(userRef, (snap) => {
                    if (snap.exists()) {
                        userTags = snap.data().tags || [];
                        renderTagList();
                        renderTagsPicker(homeworkTagsPicker, 'homework'); // Only one picker to update
                    }
                });
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        // Extend Google provider with Calendar scopes
        googleProvider.addScope('https://www.googleapis.com/auth/calendar.readonly');
        googleProvider.addScope('https://www.googleapis.com/auth/calendar.events');

        // Login with Google
        loginBtn.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const cred = GoogleAuthProvider.credentialFromResult(result);
                googleAccessToken = cred?.accessToken || null;
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
            }
        });

        // Sign out
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('You have been signed out.', 'info');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        });

        // ============================================
        // GOOGLE CALENDAR INTEGRATION
        // ============================================
        async function ensureCalendarAccess() {
            if (googleAccessToken) return googleAccessToken;
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const cred = GoogleAuthProvider.credentialFromResult(result);
                googleAccessToken = cred?.accessToken || null;
                return googleAccessToken;
            } catch (error) {
                console.error('Calendar connect failed:', error);
                throw error;
            }
        }

        function setCalendarStatus(text) {
            if (calendarStatus) calendarStatus.textContent = text || '';
        }

        function renderEvents(events = []) {
            if (!upcomingEvents) return;
            if (!events.length) {
                upcomingEvents.innerHTML = '<p class="text-sm text-gray-400">No upcoming events.</p>';
                return;
            }
            upcomingEvents.innerHTML = events.map(ev => {
                const start = ev.start?.dateTime || ev.start?.date || '';
                const when = start ? formatDueDate(start.slice(0, 10)) : '';
                return `
                    <div class="rounded border border-gray-700 bg-gray-800/60 p-2">
                        <p class="text-white text-sm font-medium">${ev.summary || '(No title)'}</p>
                        <p class="text-xs text-gray-400">${when}</p>
                    </div>
                `;
            }).join('');
        }

        async function fetchUpcomingEvents() {
            if (!upcomingEvents) return;
            try {
                setCalendarStatus('Loading events…');
                const token = await ensureCalendarAccess();
                const now = new Date().toISOString();
                const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${encodeURIComponent(now)}&singleEvents=true&maxResults=10&orderBy=startTime`;
                const res = await fetch(url, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message || 'Failed to fetch events');
                renderEvents(data.items || []);
                setCalendarStatus('');
            } catch (e) {
                console.error(e);
                setCalendarStatus('Could not load events.');
            }
        }

        async function addTaskToCalendar(task) {
            try {
                const token = await ensureCalendarAccess();
                // If no due date, open planner to set one first
                if (!task.dueDate) {
                    openTaskPlanner({ mode: 'edit', type: task.type || 'homework', taskId: task.id, taskData: task });
                    setCalendarStatus('Set a due date, then try again.');
                    showToast('Please set a due date for the task first.', 'info');
                    return;
                }
                // Create all-day event on due date
                const startDate = typeof task.dueDate === 'string' ? task.dueDate : (task.dueDate?.toDate?.() ? task.dueDate.toDate().toISOString().slice(0,10) : null);
                if (!startDate) {
                    setCalendarStatus('Invalid due date for this task.');
                    return;
                }
                const eventPayload = {
                    summary: task.title,
                    description: `${task.type === 'homework' ? 'Homework' : 'Revision'}${task.notes ? '\\n\\nNotes: ' + task.notes : ''}`,
                    start: { date: startDate },
                    end: { date: startDate }
                };
                const res = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventPayload)
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message || 'Failed to create event');
                setCalendarStatus('Event added to your calendar.');
                showToast('Task added to Google Calendar!');
                fetchUpcomingEvents();
            } catch (e) {
                console.error('Add to calendar failed:', e);
                setCalendarStatus('Could not add to calendar.');
                showToast('Could not add task to calendar.', 'error');
            }
        }

        if (connectCalendarBtn) {
            connectCalendarBtn.addEventListener('click', async () => {
                try {
                    setCalendarStatus('Connecting…');
                    await ensureCalendarAccess();
                    setCalendarStatus('');
                    showToast('Google Calendar connected successfully!');
                    fetchUpcomingEvents();
                    connectCalendarBtn.textContent = 'Calendar Connected';
                } catch {
                    showToast('Failed to connect Google Calendar.', 'error');
                    setCalendarStatus('Connection failed.');
                }
            });
        }

        // ============================================
        // FIRESTORE: USER DOCUMENT INITIALIZATION
        // ============================================
        async function initializeUserDocument(user) {
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
                // Create user document if it doesn't exist
                await setDoc(userRef, {
                    email: user.email,
                    displayName: user.displayName || 'User',
                    friends: [],
                    isStudying: false, // Add isStudying field
                    studySessions: [] // Add studySessions field
                });
            }
        }

        // ============================================
        // TASKS (Combined)
        // ============================================
        let showCompletedTasks = false;

        function renderCombinedTask(task, container) {
            const taskDiv = document.createElement('div');
            const isActive = task.isActive || false;
            const isCompleted = task.completed || false;

            taskDiv.className = `bg-gray-700 rounded-lg p-3 border-2 transition-colors ${isActive ? 'border-green-500' : 'border-transparent'} ${isCompleted ? 'completed-task opacity-60 hover:opacity-100' : ''}`;
            taskDiv.dataset.id = task.id; // Add data-id for sortable
            
            const formattedDueDate = formatDueDate(task.dueDate);
            const metadataPieces = [];
            const colorBadge = getColorBadge(task.color);
            const priorityBadge = task.priority ? getPriorityBadge(task.priority) : '';
            const tagsBadges = (task.tags || []).map(tag => renderTagChip(tag, false)).join('');
            
            if (formattedDueDate) {
                metadataPieces.push(`<span class="text-xs text-gray-400">Due ${formattedDueDate}</span>`);
            }
            if (colorBadge) {
                metadataPieces.push(colorBadge);
            }
            if (priorityBadge) {
                metadataPieces.push(priorityBadge);
            }
            
            taskDiv.innerHTML = `
                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:gap-4">
                    <div class="flex flex-1 items-start gap-3">
                        <button class="flex-shrink-0 rounded-full p-1 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-700" data-complete-task="${task.id}" title="${isCompleted ? 'Mark as incomplete' : 'Mark as complete'}">
                            ${isCompleted 
                                ? `<svg class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                                : `<svg class="h-5 w-5 text-gray-500 hover:text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
                            }
                        </button>
                        <div class="flex-1">
                            <span class="${isCompleted ? 'line-through text-gray-400' : 'text-white'} font-medium">${task.title}</span>
                            ${metadataPieces.length || tagsBadges ? `<div class="mt-2 flex flex-wrap items-center gap-2">${metadataPieces.join('')}${tagsBadges ? (metadataPieces.length ? '' : '') + tagsBadges : ''}</div>` : ''}
                            ${task.notes ? `<div class="mt-3 rounded-lg border border-gray-600/60 bg-gray-800/50 p-3 text-sm text-gray-200">${task.notes}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex shrink-0 items-start gap-1">
                        <button class="rounded-lg p-2 text-gray-400 hover:bg-gray-600/50 hover:text-yellow-400 focus:outline-none focus:ring-2 focus:ring-yellow-500" title="Set as active task" data-set-active="${task.id}">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path></svg>
                        </button>
                        <button class="rounded-lg p-2 text-gray-400 hover:bg-gray-600/50 hover:text-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500" title="Edit task" data-edit-task-generic="${task.id}">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
                        </button>
                        <button class="rounded-lg p-2 text-gray-400 hover:bg-gray-600/50 hover:text-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-500" title="Add to Google Calendar" data-add-to-calendar="${task.id}">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </button>
                        <button class="rounded-lg p-2 text-gray-400 hover:bg-gray-600/50 hover:text-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-500" title="${task.exercises && task.exercises.length ? 'Edit Exercises' : 'Add Exercises'}" data-task-id="${task.id}" data-add-exercise>
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                        </button>
                        <button class="rounded-lg p-2 text-gray-400 hover:bg-gray-600/50 hover:text-red-400 focus:outline-none focus:ring-2 focus:ring-red-500" title="Delete task" data-delete-task="${task.id}">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>
            `;

            const completeBtn = taskDiv.querySelector('[data-complete-task]');
            if (completeBtn) {
                completeBtn.addEventListener('click', async () => {
                    const taskRef = doc(db, 'tasks', task.id);
                    await updateDoc(taskRef, {
                        completed: !isCompleted
                    });
                });
            }

            const editGenericBtn = taskDiv.querySelector('[data-edit-task-generic]');
            if (editGenericBtn) {
                editGenericBtn.addEventListener('click', () => {
                    openTaskPlanner({
                        mode: 'edit',
                        type: task.type || 'homework',
                        taskId: task.id,
                        taskData: task
                    });
                });
            }

            const setActiveBtn = taskDiv.querySelector('[data-set-active]');
            if (setActiveBtn) {
                setActiveBtn.addEventListener('click', async () => {
                    const newActiveId = task.id;
                    const batch = writeBatch(db);

                    // Find and deactivate the current active task
                    const q = query(collection(db, 'tasks'), where('userId', '==', currentUser.uid), where('isActive', '==', true));
                    const activeSnapshot = await getDocs(q);
                    activeSnapshot.forEach(docSnap => {
                        if (docSnap.id !== newActiveId) {
                            batch.update(doc(db, 'tasks', docSnap.id), { isActive: false });
                        }
                    });

                    // Toggle the new active task
                    const taskRef = doc(db, 'tasks', newActiveId);
                    batch.update(taskRef, { isActive: !isActive });

                    await batch.commit();
                    showToast(isActive ? 'Task unmarked as active.' : 'Task set as active!', 'info');
                });
            }

            const deleteTaskBtn = taskDiv.querySelector('[data-delete-task]');
            if (deleteTaskBtn) {
                deleteTaskBtn.addEventListener('click', async () => {
                    if (confirm(`Are you sure you want to delete this task?\n\n"${task.title}"`)) {
                        const taskRef = doc(db, 'tasks', task.id);
                        await deleteDoc(taskRef);
                        showToast('Task deleted.', 'info');
                    }
                });
            }

            const addToCalendarBtn = taskDiv.querySelector('[data-add-to-calendar]');
            if (addToCalendarBtn) {
                addToCalendarBtn.addEventListener('click', () => addTaskToCalendar(task));
            }

            const addExerciseBtn = taskDiv.querySelector('[data-add-exercise]');
            if (addExerciseBtn) {
                addExerciseBtn.addEventListener('click', () => {
                    currentTaskId = task.id;
                    exerciseList.innerHTML = '';
                    (task.exercises || []).forEach((exercise, idx) => {
                        addExerciseToModal(exercise.text, idx);
                    });
                    exerciseModal.classList.remove('hidden');
                });
            }

            container.appendChild(taskDiv);
        }

        function loadAllTasks() {
            if (!currentUser) return;

            const q = query(
                collection(db, 'tasks'),
                where('userId', '==', currentUser.uid),
                orderBy('order', 'asc') // Order by the new 'order' field
            );

            onSnapshot(q, (snapshot) => {
                if (!combinedTaskList) return;
                combinedTaskList.innerHTML = '';

                const items = [];
                snapshot.forEach((docSnap) => {
                    items.push({ id: docSnap.id, ...docSnap.data() });
                });
                
                const hasCompleted = items.some(t => t.completed);
                toggleCompletedBtn.classList.toggle('hidden', !hasCompleted);

                const visibleItems = items; // All items are fetched, visibility is handled by CSS

                visibleItems.forEach((task) => renderCombinedTask(task, combinedTaskList));

                if (visibleItems.length === 0) {
                    combinedTaskList.innerHTML = '<p class="text-sm text-gray-400">No tasks yet.</p>';
                } else {
                    // Destroy previous instance if it exists to avoid memory leaks
                    if (Sortable.get(combinedTaskList)) Sortable.get(combinedTaskList).destroy();

                    // Initialize SortableJS after tasks are rendered
                    new Sortable(combinedTaskList, {
                        animation: 150,
                        ghostClass: 'bg-gray-600',
                        onEnd: async (evt) => {
                            const taskIds = Array.from(evt.target.children).map(child => child.dataset.id);
                            
                            // Create a batch write to update the 'order' of all tasks
                            const batch = writeBatch(db);
                            taskIds.forEach((id, index) => {
                                if (id) {
                                    const taskRef = doc(db, 'tasks', id);
                                    batch.update(taskRef, { order: index });
                                }
                            });

                            try {
                                await batch.commit();
                                showToast('Task order saved!', 'info');
                            } catch (error) {
                                console.error("Error reordering tasks: ", error);
                                showToast('Could not save new task order.', 'error');
                                // Note: The UI will be out of sync with the DB here.
                                // A full reload of tasks might be needed to correct it.
                                loadAllTasks();
                            }
                        }
                    });
                }
            });
        }

        if (toggleCompletedBtn) {
            toggleCompletedBtn.addEventListener('click', () => {
                showCompletedTasks = !showCompletedTasks;
                combinedTaskList.classList.toggle('hide-completed', !showCompletedTasks);
                toggleCompletedBtn.textContent = showCompletedTasks ? 'Hide Completed' : 'Show Completed';
            });
        }
        // Initial state
        combinedTaskList.classList.add('hide-completed');


        // Add homework task
        addHomeworkBtn.addEventListener('click', async () => {
            const title = homeworkInput.value.trim();
            if (!title || !currentUser) return;

            const settings = taskComposerState.homework;

            // Get the current highest order value to place the new task at the top
            const tasksQuery = query(collection(db, 'tasks'), where('userId', '==', currentUser.uid), orderBy('order', 'asc'), limit(1));
            const querySnapshot = await getDocs(tasksQuery);
            const highestOrder = querySnapshot.empty ? 0 : (querySnapshot.docs[0].data().order || 0);

            try {
                await addDoc(collection(db, 'tasks'), {
                    title: title,
                    type: 'homework', // This is now the only type
                    completed: false,
                    userId: currentUser.uid,                    order: highestOrder - 1, // Add to the top of the list
                    isActive: false,
                    createdAt: serverTimestamp(),
                    exercises: [],
                    dueDate: settings.dueDate || null,
                    color: settings.color === 'none' ? null : settings.color,
                    priority: settings.priority || 'medium',
                    notes: settings.notes?.trim() || '',
                    tags: (settings.tags || []).map(t => ({ id: t.id, name: t.name, color: t.color }))
                });
                homeworkInput.value = '';
                if (taskComposerState.homework.notes) {
                    taskComposerState.homework.notes = '';
                    updateTaskComposerSummary('homework');
                }
                showToast('Task added successfully!');
            } catch (error) {
                console.error('Error adding homework:', error);
                showToast('Failed to add task.', 'error');
            }
        });

        homeworkInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addHomeworkBtn.click();
            }
        });

        // ============================================
        // FRIENDS & ACTIVITY
        // ============================================
        let showCompletedFriendsTasks = false;

        function loadFriends() {
            if (!currentUser) return;

            const userRef = doc(db, 'users', currentUser.uid);
            onSnapshot(userRef, async (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.data();
                    const friends = userData.friends || [];
                    
                    if (friends.length === 0) {
                        friendsList.innerHTML = '<p class="text-sm text-gray-400">No friends yet. Add a friend by their User ID!</p>';
                        return;
                    }

                    friendsList.innerHTML = '';
                    
                    // Fetch friend details
                    for (const friendUid of friends) {
                        try {
                            const friendDoc = await getDoc(doc(db, 'users', friendUid));
                            if (friendDoc.exists()) {
                                const friendData = friendDoc.data();
                                const friendDiv = document.createElement('div');
                                friendDiv.className = 'bg-gray-700 rounded p-2 flex items-center justify-between';
                                friendDiv.innerHTML = `
                                    <div>
                                        <p class="text-white font-medium">${friendData.displayName || 'Unknown'}</p>
                                        <p class="text-xs text-gray-400">${friendData.email || friendUid}</p>
                                    </div>
                                    <button class="text-red-400 hover:text-red-300 text-sm" data-remove-friend="${friendUid}">Remove</button>
                                `;
                                
                                const removeBtn = friendDiv.querySelector('[data-remove-friend]');
                                removeBtn.addEventListener('click', async () => {
                                    await removeFriend(friendUid);
                                });
                                
                                friendsList.appendChild(friendDiv);
                            }
                        } catch (error) {
                            console.error('Error loading friend:', error);
                        }
                    }
                }
            });
        }

        // Add friend
        addFriendBtn.addEventListener('click', async () => {
            const friendUid = friendInput.value.trim();
            if (!friendUid || !currentUser) return;

            if (friendUid === currentUser.uid) {
                showToast('You cannot add yourself as a friend!', 'error');
                return;
            }

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    friends: arrayUnion(friendUid)
                });
                friendInput.value = '';
                showToast('Friend added successfully!');
            } catch (error) {
                console.error('Error adding friend:', error);
                showToast('Failed to add friend. Check the User ID.', 'error');
            }
        });

        friendInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addFriendBtn.click();
            }
        });

        // Remove friend
        async function removeFriend(friendUid) {
            if (!currentUser) return;
            
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    friends: arrayRemove(friendUid)
                });
                showToast('Friend removed.', 'info');
            } catch (error) {
                console.error('Error removing friend:', error);
                showToast('Failed to remove friend.', 'error');
            }
        }

        function renderFriendActivityTask(item, container) {
            const taskDiv = document.createElement('div');
            const isActive = item.isActive || false;
            const isCompleted = item.completed || false;

            taskDiv.className = `bg-gray-700 rounded-lg p-3 border-2 transition-colors ${isActive ? 'border-green-500' : 'border-transparent'} ${isCompleted ? 'completed-task opacity-60' : ''}`;
            
            const formattedDueDate = formatDueDate(item.dueDate);
            const metadataPieces = [];
            const colorBadge = getColorBadge(item.color);
            const priorityBadge = item.priority ? getPriorityBadge(item.priority) : '';
            const tagsBadges = (item.tags || []).map(tag => renderTagChip(tag, false)).join('');
            
            if (formattedDueDate) {
                metadataPieces.push(`<span class="text-xs text-gray-400">Due ${formattedDueDate}</span>`);
            }
            if (colorBadge) {
                metadataPieces.push(colorBadge);
            }
            if (priorityBadge) {
                metadataPieces.push(priorityBadge);
            }

            taskDiv.innerHTML = `
                <div class="flex flex-col gap-3">
                    <div class="flex items-center gap-2">
                        <img src="${item.friendPhotoURL || ''}" alt="${item.friendName}" class="h-6 w-6 rounded-full border border-gray-600 object-cover">
                        <p class="text-sm font-semibold text-blue-300">${item.friendName}</p>
                    </div>
                    <div class="flex flex-1 items-start gap-3 pl-8">
                        ${isCompleted 
                            ? `<svg class="mt-0.5 h-5 w-5 flex-shrink-0 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`
                            : `<svg class="mt-0.5 h-5 w-5 flex-shrink-0 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
                        }
                        <div class="flex-1">
                            <span class="${isCompleted ? 'line-through text-gray-400' : 'text-white'} font-medium">${item.title}</span>
                            ${metadataPieces.length || tagsBadges ? `<div class="mt-2 flex flex-wrap items-center gap-2">${metadataPieces.join('')}${tagsBadges ? (metadataPieces.length ? '' : '') + tagsBadges : ''}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(taskDiv);
        }

        function loadFriendsActivity() {
            if (!currentUser) return;

            const userRef = doc(db, 'users', currentUser.uid);
            onSnapshot(userRef, async (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.data();
                    const friends = userData.friends || [];
                    
                    if (friends.length === 0) {
                        friendsActivity.innerHTML = '<p class="text-sm text-gray-400">No activity to show. Add friends to see their progress!</p>';
                        return;
                    }

                    friendsActivity.innerHTML = '';
                    // Firestore 'in' queries are limited to 30 items in the array.
                    // We chunk the friends list to handle this limitation.
                    const friendChunks = [];
                    const chunkSize = 30;
                    for (let i = 0; i < friends.length; i += chunkSize) {
                        friendChunks.push(friends.slice(i, i + chunkSize));
                    }

                    for (const chunk of friendChunks) {
                        const q = query(
                            collection(db, 'tasks'),
                            where('userId', 'in', chunk),
                            orderBy('createdAt', 'desc')
                        );

                        onSnapshot(q, async (snapshot) => {
                            // This listener will re-run for any change in this chunk.
                            // We need to rebuild the list to reflect changes.
                            friendsActivity.innerHTML = '';

                            let allItems = [];
                            let existingItems = [];
                            snapshot.forEach((docSnap) => {
                                const task = { id: docSnap.id, ...docSnap.data() };
                                existingItems.push(task);
                            });

                            // Get friend names for the tasks in this chunk
                            const activityItems = await Promise.all(
                                existingItems.map(async (task) => {
                                    try {
                                        const friendDoc = await getDoc(doc(db, 'users', task.userId));
                                        const friendData = friendDoc.exists() ? friendDoc.data() : null;
                                        return {
                                            ...task,                                            friendName: friendData?.displayName || 'Unknown',
                                            friendPhotoURL: friendData?.photoURL || ''
                                        };
                                    } catch (error) {
                                        return { ...task, friendName: 'Unknown', friendPhotoURL: '' };
                                    }
                                })
                            );

                            allItems.push(...activityItems);

                            // Sort all items by creation time
                            allItems.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));

                            const hasCompleted = allItems.some(t => t.completed);
                            toggleFriendsCompletedBtn.classList.toggle('hidden', !hasCompleted);

                            if (allItems.length === 0) {
                                friendsActivity.innerHTML = '<p class="text-sm text-gray-400">No tasks from friends yet.</p>';
                            } else {
                                allItems.forEach(item => renderFriendActivityTask(item, friendsActivity));
                            }
                        });
                    }
                }
            });
        }

        if (toggleFriendsCompletedBtn) {
            toggleFriendsCompletedBtn.addEventListener('click', () => {
                showCompletedFriendsTasks = !showCompletedFriendsTasks;
                friendsActivity.classList.toggle('hide-completed', !showCompletedFriendsTasks);
                toggleFriendsCompletedBtn.textContent = showCompletedFriendsTasks ? 'Hide Completed' : 'Show Completed';
            });
        }
        friendsActivity.classList.add('hide-completed');

        // ============================================
        // STUDY TIMER (POMODORO)
        // ============================================
        let timerInterval = null;
        let timerSeconds = 25 * 60; // 25 minutes in seconds
        let isBreak = false;
        let isRunning = false;

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer() {
            if (isRunning) return;
            
            isRunning = true;
            timerStatus.textContent = isBreak ? 'Break time!' : 'Study time!';
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    
                    if (!isBreak) {
                        // Switch to break
                        isBreak = true;
                        timerSeconds = 5 * 60; // 5 minutes break
                        timerStatus.textContent = 'Break time! Take a rest.';
                        updateTimerDisplay();
                        // Auto-start break timer
                        setTimeout(() => {
                            startTimer();
                        }, 1000);
                    } else {
                        // Break finished, reset to study
                        isBreak = false;
                        timerSeconds = 25 * 60;
                        timerStatus.textContent = 'Break finished! Ready for another session.';
                        updateTimerDisplay();
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                isRunning = false;
                timerStatus.textContent = isBreak ? 'Break paused' : 'Study paused';
            }
        }

        function resetTimer() {
            pauseTimer();
            isBreak = false;
            timerSeconds = 25 * 60;
            timerStatus.textContent = 'Ready to start';
            updateTimerDisplay();
        }

        timerStartBtn.addEventListener('click', startTimer);
        timerPauseBtn.addEventListener('click', pauseTimer);
        timerResetBtn.addEventListener('click', resetTimer);

        // ============================================
        // EXERCISE MODAL
        // ============================================
        let currentExercises = [];

        function addExerciseToModal(text, idx = null) {
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'flex items-center gap-2 bg-gray-700 rounded p-2';
            
            if (idx !== null) {
                exerciseDiv.innerHTML = `
                    <span class="text-white flex-1">${text}</span>
                    <button class="text-red-400 hover:text-red-300 text-sm" data-remove-exercise="${idx}">Remove</button>
                `;
                
                const removeBtn = exerciseDiv.querySelector('[data-remove-exercise]');
                removeBtn.addEventListener('click', () => {
                    currentExercises.splice(idx, 1);
                    exerciseDiv.remove();
                });
            } else {
                exerciseDiv.innerHTML = `
                    <span class="text-white flex-1 break-all">${text}</span>
                    <button class="text-red-400 hover:text-red-300 text-sm" data-remove-exercise-new>Remove</button>
                `;
                
                const removeBtn = exerciseDiv.querySelector('[data-remove-exercise-new]');
                removeBtn.addEventListener('click', () => {
                    exerciseDiv.remove();
                    const idx = Array.from(exerciseList.children).indexOf(exerciseDiv);
                    if (idx >= 0 && idx < currentExercises.length) {
                        currentExercises.splice(idx, 1);
                    }
                });
            }
            
            exerciseList.appendChild(exerciseDiv);
        }

        addExerciseBtn.addEventListener('click', () => {
            const text = exerciseInput.value.trim();
            if (!text) return;

            currentExercises.push({ text: text, completed: false });
            addExerciseToModal(text);
            exerciseInput.value = '';
        });

        exerciseInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addExerciseBtn.click();
            }
        });

        saveExercisesBtn.addEventListener('click', async () => {
            if (!currentTaskId || !currentUser) return;

            try {
                // Get existing exercises from the task
                const taskRef = doc(db, 'tasks', currentTaskId);
                const taskSnap = await getDoc(taskRef);
                
                if (taskSnap.exists()) {
                    const existingExercises = taskSnap.data().exercises || [];
                    // Merge: keep existing exercises, add new ones
                    const allExercises = [...existingExercises];
                    
                    // Add new exercises that aren't duplicates
                    currentExercises.forEach(newEx => {
                        if (!allExercises.some(ex => ex.text === newEx.text)) {
                            allExercises.push(newEx);
                        }
                    });

                    await updateDoc(taskRef, {
                        exercises: allExercises
                    });

                    exerciseModal.classList.add('hidden');
                    currentExercises = [];
                    exerciseList.innerHTML = '';
                    exerciseInput.value = '';
                    showToast('Exercises saved!');
                }
            } catch (error) {
                console.error('Error saving exercises:', error);
                showToast('Failed to save exercises.', 'error');
            }
        });

        closeExerciseModal.addEventListener('click', () => {
            exerciseModal.classList.add('hidden');
            currentExercises = [];
            exerciseList.innerHTML = '';
            exerciseInput.value = '';
        });

        // Close modal on outside click
        exerciseModal.addEventListener('click', (e) => {
            if (e.target === exerciseModal) {
                exerciseModal.classList.add('hidden');
                currentExercises = [];
                exerciseList.innerHTML = '';
                exerciseInput.value = '';
            }
        });

        // Initialize timer display
        updateTimerDisplay();

        // ============================================
        // WIDGET VISIBILITY
        // ============================================
        const WIDGET_VISIBILITY_KEY = 'studyhub_widget_visibility';

        function getWidgetName(widgetId) {
            const names = {
                'tasks': 'Tasks',
                'calendar': 'Google Calendar',
                'friends-activity': "Friends' Activity",
                'study-timer': 'Study Timer (Pomodoro)',
                'music': 'Music',
                'revision-session': 'Revision Session'
            };
            return names[widgetId] || widgetId;
        }

        function saveWidgetVisibility() {
            const visibilityState = {};
            ALL_WIDGETS.forEach(widget => {
                const id = widget.dataset.widgetId;
                if (id) {
                    visibilityState[id] = !widget.classList.contains('hidden');
                }
            });
            localStorage.setItem(WIDGET_VISIBILITY_KEY, JSON.stringify(visibilityState));
        }

        function loadWidgetVisibility() {
            const savedState = localStorage.getItem(WIDGET_VISIBILITY_KEY);
            if (!savedState) return;

            try {
                const visibilityState = JSON.parse(savedState);
                ALL_WIDGETS.forEach(widget => {
                    const id = widget.dataset.widgetId;
                    if (id in visibilityState) {
                        widget.classList.toggle('hidden', !visibilityState[id]);
                    }
                });
            } catch (e) {
                console.error("Failed to load widget visibility:", e);
            }
        }

        function renderWidgetVisibilityControls() {
            if (!widgetVisibilityList) return;
            widgetVisibilityList.innerHTML = '';

            ALL_WIDGETS.forEach(widget => {
                const id = widget.dataset.widgetId;
                if (!id) return;

                const isVisible = !widget.classList.contains('hidden');
                const label = document.createElement('label');
                label.className = 'flex items-center justify-between cursor-pointer';
                label.innerHTML = `
                    <span class="text-sm text-gray-200">${getWidgetName(id)}</span>
                    <input type="checkbox" class="sr-only peer" ${isVisible ? 'checked' : ''}>
                    <div class="relative w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                `;
                label.querySelector('input').addEventListener('change', (e) => {
                    widget.classList.toggle('hidden', !e.target.checked);
                    saveWidgetVisibility();
                });
                widgetVisibilityList.appendChild(label);
            });
        }

        // ============================================
        // WIDGET RE-ORDERING
        // ============================================
        const WIDGET_ORDER_KEY = 'studyhub_widget_order';
        let sortableInstance = null;

        function saveWidgetOrder() {
            if (!mainGrid) return;
            const widgetIds = Array.from(mainGrid.children).map(widget => widget.dataset.widgetId).filter(id => id);
            localStorage.setItem(WIDGET_ORDER_KEY, JSON.stringify(widgetIds));
        }

        function loadWidgetOrder() {
            if (!mainGrid) return;
            const savedOrder = localStorage.getItem(WIDGET_ORDER_KEY);
            if (savedOrder) {
                try {
                    const widgetIds = JSON.parse(savedOrder);
                    const widgetMap = new Map();
                    Array.from(mainGrid.children).forEach(widget => {
                        const id = widget.dataset.widgetId;
                        if (id) widgetMap.set(id, widget);
                    });

                    // Re-append children in the saved order
                    widgetIds.forEach(id => {
                        const widget = widgetMap.get(id);
                        if (widget) mainGrid.appendChild(widget);
                    });
                } catch (e) {
                    console.error("Failed to load widget order:", e);
                }
            }
        }

        function toggleReorderMode() {
            if (sortableInstance) {
                sortableInstance.destroy();
                sortableInstance = null;
                toggleReorderBtn.textContent = 'Enable Re-order Mode';
                toggleReorderBtn.classList.replace('bg-red-600', 'bg-indigo-600');
                reorderStatus.classList.add('hidden');
                saveWidgetOrder();
                showToast('Layout saved!', 'success');
            } else {
                sortableInstance = new Sortable(mainGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                });
                toggleReorderBtn.textContent = 'Save Layout';
                toggleReorderBtn.classList.replace('bg-indigo-600', 'bg-red-600');
                reorderStatus.classList.remove('hidden');
            }
        }
        toggleReorderBtn.addEventListener('click', toggleReorderMode);

        // ============================================
        // ZEN MODE
        // ============================================
        let isZenMode = false;

        function toggleZenMode() {
            isZenMode = !isZenMode;
            document.body.classList.toggle('zen-mode', isZenMode);
            zenModeBtnText.textContent = isZenMode ? 'Exit Zen' : 'Zen Mode';
            zenModeBtn.classList.toggle('bg-blue-600', isZenMode);
            zenModeBtn.classList.toggle('hover:bg-blue-500', isZenMode);
            zenModeBtn.classList.toggle('bg-gray-800/80', !isZenMode);
        }

        if (zenModeBtn) {
            zenModeBtn.addEventListener('click', toggleZenMode);
        }
    </script>
    <script type="module">
        // REVISION SESSION SCRIPT
        import { getFirestore, doc, updateDoc, arrayUnion, onSnapshot, getDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';

        const db = getFirestore();
        const auth = getAuth();

        // DOM Elements
        const revisionTimerDisplay = document.getElementById('revisionTimerDisplay');
        const revisionStartBtn = document.getElementById('revisionStartBtn');
        const revisionPauseBtn = document.getElementById('revisionPauseBtn');
        const revisionStopBtn = document.getElementById('revisionStopBtn');
        const revisionTimerStatus = document.getElementById('revisionTimerStatus');
        const totalStudyTimeToday = document.getElementById('totalStudyTimeToday');
        const encouragementMessage = document.getElementById('encouragementMessage');
        const toggleRevisionWidgetSizeBtn = document.getElementById('toggleRevisionWidgetSizeBtn');
        const revisionSessionWidget = document.getElementById('revisionSessionWidget');
        const leaderboardContainer = document.getElementById('leaderboardContainer');
        const leaderboardTabs = document.querySelectorAll('.leaderboard-tab');
        const leaderboardToday = document.getElementById('leaderboardToday');
        const leaderboardWeekly = document.getElementById('leaderboardWeekly');
        const dailyProgressBar = document.getElementById('dailyProgressBar');
        const dailyProgressText = document.getElementById('dailyProgressText');

        const revisionSessionExpandedView = document.getElementById('revisionSessionExpandedView');
        const expandIcon = document.getElementById('expandIcon');
        const collapseIcon = document.getElementById('collapseIcon');
        // State
        let revisionInterval = null;
        let sessionSeconds = 0;
        let isRevisionRunning = false;
        let currentUser = null;
        const DAILY_GOAL_SECONDS = 8 * 3600; // 8 hours

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                listenForStudySessions();
            }
        });

        function formatSecondsToHMS(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h}h ${m}m`;
        }

        function formatTime(seconds) {
            const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
            const s = String(seconds % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function updateRevisionDisplay() {
            revisionTimerDisplay.textContent = formatTime(sessionSeconds);
        }

        async function startRevision() {
            if (isRevisionRunning || !currentUser) return;
            isRevisionRunning = true;
            revisionTimerStatus.textContent = 'Session in progress...';
            revisionStartBtn.classList.add('hidden');
            revisionPauseBtn.classList.remove('hidden');
            revisionStopBtn.classList.remove('hidden');

            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, { isStudying: true });


            revisionInterval = setInterval(() => {
                sessionSeconds++;
                updateRevisionDisplay();
            }, 1000);
        }

        async function pauseRevision() {
            clearInterval(revisionInterval);
            isRevisionRunning = false;
            revisionTimerStatus.textContent = `Paused. Press Start to resume.`;
            revisionStartBtn.textContent = 'Resume';
            revisionStartBtn.classList.remove('hidden');
            revisionPauseBtn.classList.add('hidden');

            if (currentUser) {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, { isStudying: false });
            }
        }

        async function stopRevision() {
            if (!currentUser) return;
            clearInterval(revisionInterval);
            isRevisionRunning = false;

            // Save the session duration
            if (sessionSeconds > 0) {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    studySessions: arrayUnion({
                        duration: sessionSeconds,
                        timestamp: new Date()
                    })
                });
            }

            // Update studying status
            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, { isStudying: false });

            sessionSeconds = 0;
            updateRevisionDisplay();
            revisionTimerStatus.textContent = 'Session saved! Ready for another.';
            revisionStartBtn.textContent = 'Start';
            revisionStartBtn.classList.remove('hidden');
            revisionPauseBtn.classList.add('hidden');
            revisionStopBtn.classList.add('hidden');
        }

        function getTodayDateString() {
            return new Date().toISOString().slice(0, 10);
        }

        function getStartOfWeek() {
            const now = new Date();
            const day = now.getDay(); // 0 for Sunday, 6 for Saturday
            const diff = now.getDate() - day;
            const startOfWeek = new Date(now.setDate(diff));
            startOfWeek.setHours(0, 0, 0, 0);
            return startOfWeek;
        }

        function listenForStudySessions() {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.uid);
            onSnapshot(userRef, (snap) => {
                if (!snap.exists()) return;
                const userData = snap.data();
                const sessions = userData.studySessions || [];
                const todayDate = getTodayDateString();
                const todaySeconds = sessions
                    .filter(s => s.timestamp.toDate().toISOString().slice(0, 10) === todayDate)
                    .reduce((total, s) => total + s.duration, 0);

                totalStudyTimeToday.textContent = formatSecondsToHMS(todaySeconds);
                updateProgressBar(todaySeconds);
                // Update leaderboard if it's visible
                if (!revisionSessionExpandedView.classList.contains('hidden')) {
                    updateLeaderboard();
                }
            });
        }

        function updateProgressBar(todaySeconds) {
            const progress = Math.min((todaySeconds / DAILY_GOAL_SECONDS) * 100, 100);
            dailyProgressBar.style.width = `${progress}%`;
            dailyProgressText.textContent = `${formatSecondsToHMS(todaySeconds)} / 8h 0m`;

            if (progress < 25) dailyProgressBar.className = 'bg-blue-600 h-2.5 rounded-full transition-all duration-500';
            else if (progress < 50) dailyProgressBar.className = 'bg-green-500 h-2.5 rounded-full transition-all duration-500';
            else if (progress < 75) dailyProgressBar.className = 'bg-yellow-500 h-2.5 rounded-full transition-all duration-500';
            else dailyProgressBar.className = 'bg-red-500 h-2.5 rounded-full transition-all duration-500';

            const remaining = DAILY_GOAL_SECONDS - todaySeconds;
            if (remaining > 0) {
                encouragementMessage.textContent = `${formatSecondsToHMS(remaining)} left to reach your daily goal!`;
            } else {
                encouragementMessage.textContent = `Goal reached! Amazing work today!`;
            }
        }

        async function updateLeaderboard() {
            if (!currentUser) return;
            const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
            if (!userDoc.exists()) return;

            const friends = userDoc.data().friends || [];
            const allUserIds = [currentUser.uid, ...friends];
            if (allUserIds.length === 0) return;

            const q = query(collection(db, 'users'), where('__name__', 'in', allUserIds));
            const querySnapshot = await getDocs(q);

            const todayDate = getTodayDateString();
            const todayLeaderboard = [];
            const weeklyLeaderboard = [];
            const startOfWeek = getStartOfWeek();
            const daysPassedInWeek = new Date().getDay() + 1; // 1 for Sunday, 7 for Saturday

            querySnapshot.forEach(docSnap => {
                const user = docSnap.data();
                const sessions = user.studySessions || [];
                const todaySeconds = (sessions || [])
                    .filter(s => s.timestamp && s.timestamp.toDate().toISOString().slice(0, 10) === todayDate)
                    .reduce((total, s) => total + s.duration, 0);

                todayLeaderboard.push({
                    id: docSnap.id,
                    name: user.displayName,
                    time: todaySeconds,
                    isStudying: user.isStudying || false
                });

                const totalWeeklySeconds = (sessions || [])
                    .filter(s => s.timestamp.toDate() >= startOfWeek)
                    .reduce((total, s) => total + s.duration, 0);
                
                const averageWeeklySeconds = daysPassedInWeek > 0 ? totalWeeklySeconds / daysPassedInWeek : 0;

                weeklyLeaderboard.push({
                    id: docSnap.id,
                    name: user.displayName,
                    time: averageWeeklySeconds,
                    isStudying: user.isStudying || false
                });
            });

            todayLeaderboard.sort((a, b) => b.time - a.time);
            weeklyLeaderboard.sort((a, b) => b.time - a.time);
            renderLeaderboard(leaderboardToday, todayLeaderboard);
            renderLeaderboard(leaderboardWeekly, weeklyLeaderboard, ' (avg/day)');

            // Update encouragement message based on leaderboard
            const myRank = todayLeaderboard.findIndex(u => u.id === currentUser.uid);
            if (myRank > 0) {
                const friendAhead = todayLeaderboard[myRank - 1];
                const timeDiff = friendAhead.time - todayLeaderboard[myRank].time;
                if (timeDiff > 0) {
                    encouragementMessage.textContent = `You're only ${formatSecondsToHMS(timeDiff)} away from ${friendAhead.name}!`;
                }
            }
        }

        function renderLeaderboard(container, data, timeSuffix = '') {
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = `<p class="text-sm text-gray-400">No study data yet.</p>`;
                return;
            }
            data.forEach((user, index) => {
                const isMe = user.id === currentUser.uid;
                const div = document.createElement('div');
                div.className = `flex items-center justify-between p-2 rounded ${isMe ? 'bg-blue-900/50' : 'bg-gray-700/50'}`;
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold w-6 text-center text-gray-400">${index + 1}</span>
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-white">${user.name} ${isMe ? '(You)' : ''}</span>
                            ${user.isStudying ? '<span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span></span>' : ''}
                        </div>
                    </div>
                    <span class="font-semibold text-purple-300">${formatSecondsToHMS(Math.round(user.time))}${timeSuffix}</span>
                `;
                container.appendChild(div);
            });
        }

        // Event Listeners
        revisionStartBtn.addEventListener('click', startRevision);
        revisionPauseBtn.addEventListener('click', pauseRevision);
        revisionStopBtn.addEventListener('click', stopRevision);

        toggleRevisionWidgetSizeBtn.addEventListener('click', () => {
            const isExpanded = revisionSessionWidget.classList.toggle('md:col-span-3');
            revisionSessionExpandedView.classList.toggle('hidden');
            expandIcon.classList.toggle('hidden');
            collapseIcon.classList.toggle('hidden');
            toggleRevisionWidgetSizeBtn.setAttribute('title', isExpanded ? 'Collapse' : 'Expand');

            if (isExpanded) {
                updateLeaderboard();
            }
        });

        leaderboardTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                leaderboardTabs.forEach(t => t.classList.replace('bg-gray-700', 'bg-gray-800'));
                tab.classList.replace('bg-gray-800', 'bg-gray-700');
                const tabName = tab.dataset.leaderboardTab;
                leaderboardToday.classList.toggle('hidden', tabName !== 'today');
                leaderboardWeekly.classList.toggle('hidden', tabName !== 'weekly');
                // The leaderboard is now updated automatically, so no need for a placeholder
                if (tabName === 'weekly') {
                    updateLeaderboard(); // Re-calculate and render when switching to weekly
                }
            });
        });
    </script>
</body>
</html>
