<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyHub Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for dark mode */
        body {
            min-height: 100vh;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Login Screen (shown when user is not authenticated) -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen">
        <div class="text-center">
            <h1 class="text-4xl font-bold mb-8 text-white">StudyHub Dashboard</h1>
            <button id="loginBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex items-center gap-2 mx-auto">
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Login with Google
            </button>
        </div>
    </div>

    <!-- Dashboard (shown when user is authenticated) -->
    <div id="dashboard" class="hidden p-4 md:p-6 lg:p-8">
        <!-- Header -->
        <header class="mb-6 flex items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white mb-2">StudyHub Dashboard</h1>
                <p class="text-gray-400">Welcome back! Let's get productive.</p>
            </div>
            <button id="menuToggle" class="inline-flex items-center gap-2 rounded-lg border border-gray-700 bg-gray-800/80 px-3 py-2 text-sm font-semibold text-gray-200 shadow hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 transition">
                <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                    <path d="M4 6h16M4 12h16M4 18h16" stroke-linecap="round"/>
                </svg>
                Menu
            </button>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
            <!-- Profile Widget moved to side panel -->

            <!-- Combined Tasks Widget (Left, spans 2 columns) -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6 md:col-span-2">
                <h2 class="text-xl font-bold mb-4 text-white">Tasks</h2>
                <div class="space-y-4" id="homeworkWidget">
                    <div>
                        <div class="flex gap-2 mb-3">
                            <button class="px-3 py-1 text-sm font-medium rounded transition task-tab bg-gray-700 text-white border border-gray-600" data-tab-group="homework" data-tab="quick">
                                Quick Add
                            </button>
                            <button class="px-3 py-1 text-sm font-medium rounded transition task-tab bg-gray-800 text-gray-300 border border-transparent hover:bg-gray-700/70" data-tab-group="homework" data-tab="advanced">
                                Advanced Options
                            </button>
                        </div>
                        <div class="flex flex-col gap-2 md:flex-row">
                            <input type="text" id="homeworkInput" placeholder="Add homework task..." class="flex-1 bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 focus:outline-none focus:border-blue-500">
                            <button id="addHomeworkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200 md:self-stretch">
                                Add
                            </button>
                        </div>
                        <div id="homeworkAdvancedOptions" class="hidden mt-3 space-y-4 rounded-xl border border-gray-700/60 bg-gray-800/70 p-4">
                            <div>
                                <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-400">Quick due dates</p>
                                <div class="flex flex-wrap gap-2">
                                    <button class="rounded-full border border-gray-600 bg-gray-700 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-quick-homework-due="today">
                                        Today
                                    </button>
                                    <button class="rounded-full border border-gray-600 bg-gray-700 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-quick-homework-due="tomorrow">
                                        Tomorrow
                                    </button>
                                    <button class="rounded-full border border-gray-600 bg-gray-700 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-quick-homework-due="week">
                                        Next week
                                    </button>
                                    <button class="rounded-full border border-gray-600 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-400 hover:border-red-500 hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-500" data-quick-homework-due="clear">
                                        Clear date
                                    </button>
                                </div>
                            </div>
                            <div class="rounded-lg border border-gray-700 bg-gray-900/40 p-3">
                                <p class="mb-1 text-xs font-semibold uppercase tracking-wide text-gray-500">Current settings</p>
                                <div id="homeworkSettingsSummary" class="text-sm text-gray-300">No due date • Color: None • Priority: Medium</div>
                            </div>
                            <div class="rounded-lg border border-gray-700 bg-gray-900/40 p-3">
                                <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-500">Tags</p>
                                <div id="homeworkTagsPicker" class="flex flex-wrap gap-2"></div>
                                <p class="mt-1 text-xs text-gray-500">Manage tags in the side panel → Tags.</p>
                            </div>
                            <div class="flex flex-wrap gap-2">
                                <button id="homeworkPlannerBtn" class="inline-flex items-center gap-2 rounded-lg border border-blue-500/60 bg-blue-600/20 px-3 py-2 text-sm font-semibold text-blue-200 hover:bg-blue-600/30 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6">
                                        <path d="M8 7h8M8 11h4M5 5h14a2 2 0 0 1 2 2v12l-4-3-4 3-4-3-4 3V7a2 2 0 0 1 2-2z" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Open planner
                                </button>
                                <button id="homeworkClearSettingsBtn" class="inline-flex items-center gap-2 rounded-lg border border-gray-600 bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-500">
                                    Reset settings
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Combined Task List -->
                    <div id="combinedTaskList" class="space-y-3 max-h-[38rem] overflow-y-auto"></div>
                </div>
            </div>

            <!-- Calendar Widget (Right column) -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Google Calendar</h2>
                <div class="space-y-3">
                    <button id="connectCalendarBtn" class="w-full rounded-lg bg-blue-600 px-4 py-2 font-semibold text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        Connect Google Calendar
                    </button>
                    <div id="calendarStatus" class="text-xs text-gray-400"></div>
                    <div id="upcomingEvents" class="space-y-2 max-h-96 overflow-y-auto">
                        <p class="text-sm text-gray-400">Connect to see your upcoming events.</p>
                    </div>
                </div>
            </div>

            <!-- Friends' Activity Widget -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Friends' Activity</h2>
                <div id="friendsActivity" class="space-y-3 max-h-96 overflow-y-auto">
                    <p class="text-sm text-gray-400">No activity to show. Add friends to see their progress!</p>
                </div>
            </div>

            <!-- Study Timer Widget -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Study Timer</h2>
                <div class="text-center space-y-4">
                    <div id="timerDisplay" class="text-5xl font-mono font-bold text-blue-400">25:00</div>
                    <div class="flex gap-2 justify-center">
                        <button id="timerStartBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Start
                        </button>
                        <button id="timerPauseBtn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Pause
                        </button>
                        <button id="timerResetBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                            Reset
                        </button>
                    </div>
                    <p id="timerStatus" class="text-sm text-gray-400">Ready to start</p>
                </div>
            </div>

            <!-- Google Calendar Widget -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Google Calendar</h2>
                <div class="aspect-video bg-gray-700 rounded overflow-hidden">
                    <iframe id="calendarFrame" src="" class="w-full h-full border-0" allow="calendar"></iframe>
                    <p class="text-sm text-gray-400 p-4 text-center">Add your public calendar embed URL</p>
                </div>
            </div>

            <!-- Music Widget -->
            <div class="bg-gray-800 rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold mb-4 text-white">Music</h2>
                <div class="aspect-video bg-gray-700 rounded overflow-hidden">
                    <iframe id="musicFrame" src="" class="w-full h-full border-0" allow="autoplay"></iframe>
                    <p class="text-sm text-gray-400 p-4 text-center">Add your Spotify/YouTube playlist embed URL</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div id="sidePanelOverlay" class="fixed inset-0 z-40 hidden bg-black/70 backdrop-blur-sm"></div>
    <aside id="sidePanel" class="fixed inset-y-0 right-0 z-50 w-full max-w-md translate-x-full transform border-l border-gray-800 bg-gray-900/95 shadow-2xl transition-transform duration-300 ease-in-out lg:max-w-sm">
        <div class="flex h-full flex-col">
            <div class="flex items-center justify-between border-b border-gray-800 px-5 py-4">
                <div>
                    <p class="text-xs uppercase tracking-wide text-gray-500">Quick Actions</p>
                    <h2 class="text-lg font-semibold text-white">Control Center</h2>
                </div>
                <button id="sidePanelCloseBtn" class="rounded-full border border-gray-700 bg-gray-800/70 p-2 text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M6 6l12 12M6 18L18 6" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="border-b border-gray-800 px-5 py-3">
                <div class="flex gap-2">
                    <button class="side-panel-tab rounded-lg border border-blue-500/60 bg-blue-600/20 px-3 py-2 text-sm font-semibold text-blue-200 hover:bg-blue-600/30 focus:outline-none focus:ring-2 focus:ring-blue-500" data-side-panel-tab="friends">
                        Friends
                    </button>
                    <button class="side-panel-tab rounded-lg border border-transparent bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" data-side-panel-tab="music">
                        Music Links
                    </button>
                    <button class="side-panel-tab rounded-lg border border-transparent bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" data-side-panel-tab="profile">
                        Profile
                    </button>
                    <button class="side-panel-tab rounded-lg border border-transparent bg-gray-800 px-3 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600" data-side-panel-tab="tags">
                        Tags
                    </button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto px-5 pb-6">
                <div data-side-panel-section="friends" class="space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-2 text-sm font-semibold text-white">Add a friend</h3>
                        <div class="flex gap-2">
                            <input type="text" id="friendInput" placeholder="Friend's User ID..." class="flex-1 rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="addFriendBtn" class="rounded-lg bg-purple-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-400">
                                Add
                            </button>
                        </div>
                        <p class="mt-2 text-xs text-gray-400">Share your User ID to connect with classmates.</p>
                    </div>
                    <div class="rounded-xl border border-gray-800 bg-gray-800/40 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Friends list</h3>
                        <div id="friendsList" class="space-y-2 max-h-80 overflow-y-auto pr-1">
                            <p class="text-sm text-gray-400">No friends yet. Add a friend by their User ID!</p>
                        </div>
                    </div>
                </div>
                <div data-side-panel-section="music" class="hidden space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-2 text-sm font-semibold text-white">Music links</h3>
                        <p class="mb-3 text-xs text-gray-400">Save playlists or lo-fi streams to launch them quickly. Links are stored locally on this device.</p>
                        <div class="flex gap-2">
                            <input type="url" id="musicLinkInput" placeholder="https://open.spotify.com/..." class="flex-1 rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <button id="addMusicLinkBtn" class="rounded-lg bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-400">
                                Save
                            </button>
                        </div>
                    </div>
                    <div class="rounded-xl border border-gray-800 bg-gray-800/40 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Saved links</h3>
                        <ul id="musicLinksList" class="space-y-2 text-sm text-gray-200"></ul>
                        <p id="musicLinksEmptyState" class="text-xs text-gray-500">No links yet. Add your favorite playlists above.</p>
                    </div>
                </div>
                <div data-side-panel-section="profile" class="hidden space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Your profile</h3>
                        <div id="profileContent" class="space-y-4">
                            <div class="flex items-center gap-4">
                                <img id="userPhoto" src="" alt="User" class="h-16 w-16 rounded-full border-2 border-gray-600 object-cover">
                                <div>
                                    <p id="userName" class="font-semibold text-white"></p>
                                    <p id="userEmail" class="text-sm text-gray-400"></p>
                                </div>
                            </div>
                            <div class="rounded-lg border border-gray-700 bg-gray-900/40 p-3">
                                <p class="text-xs uppercase tracking-wide text-gray-400">User ID</p>
                                <p id="userId" class="mt-1 break-all rounded bg-gray-800 p-2 font-mono text-xs text-gray-300"></p>
                            </div>
                            <button id="signOutBtn" class="w-full rounded-lg bg-red-600 px-4 py-2 font-semibold text-white shadow hover:bg-red-500 focus:outline-none focus:ring-2 focus:ring-red-400">
                                Sign Out
                            </button>
                        </div>
                    </div>
                </div>
                <div data-side-panel-section="tags" class="hidden space-y-4">
                    <div class="rounded-xl border border-gray-800 bg-gray-800/60 p-4 shadow-sm">
                        <h3 class="mb-2 text-sm font-semibold text-white">Create a tag</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <input type="text" id="newTagName" placeholder="Tag name (e.g., Math)" class="sm:col-span-2 rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <select id="newTagColor" class="rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="red">Red</option>
                                <option value="yellow">Yellow</option>
                                <option value="purple">Purple</option>
                                <option value="teal">Teal</option>
                            </select>
                        </div>
                        <div class="mt-2">
                            <button id="addTagBtn" class="rounded-lg bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400">Add tag</button>
                        </div>
                    </div>
                    <div class="rounded-xl border border-gray-800 bg-gray-800/40 p-4 shadow-sm">
                        <h3 class="mb-3 text-sm font-semibold text-white">Your tags</h3>
                        <div id="tagList" class="flex flex-wrap gap-2"></div>
                        <p id="tagListEmpty" class="text-xs text-gray-500">No tags yet. Create one above.</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Task Planner Modal -->
    <div id="taskPlannerModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
        <div class="w-full max-w-2xl rounded-2xl border border-gray-800 bg-gray-900/95 shadow-2xl">
            <div class="flex items-start justify-between border-b border-gray-800 px-6 py-4">
                <div>
                    <p id="plannerSubtitle" class="text-xs uppercase tracking-wide text-gray-500">Plan task</p>
                    <h3 id="plannerTitle" class="text-xl font-semibold text-white">Task planner</h3>
                </div>
                <button id="plannerCloseBtn" class="rounded-full border border-gray-700 bg-gray-800/70 p-2 text-gray-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <path d="M6 6l12 12M6 18L18 6" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="grid gap-6 px-6 py-6 md:grid-cols-2">
                <div class="space-y-4">
                    <div>
                        <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-400">Due date</p>
                        <input type="date" id="plannerDueDate" class="w-full rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <div class="mt-2 flex flex-wrap gap-2">
                            <button class="rounded-full border border-gray-700 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-planner-quick="today">Today</button>
                            <button class="rounded-full border border-gray-700 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-planner-quick="tomorrow">Tomorrow</button>
                            <button class="rounded-full border border-gray-700 bg-gray-800 px-3 py-1 text-xs font-medium text-gray-200 hover:border-blue-500 hover:text-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-500" data-planner-quick="week">Next week</button>
                            <button class="rounded-full border border-gray-700 bg-gray-900 px-3 py-1 text-xs font-medium text-gray-400 hover:border-red-500 hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-500" data-planner-quick="clear">Clear</button>
                        </div>
                    </div>
                    <div>
                        <p class="mb-2 text-xs font-semibold uppercase tracking-wide text-gray-400">Notes</p>
                        <textarea id="plannerNotes" rows="5" placeholder="Add context, study materials or links..." class="w-full rounded-lg border border-gray-700 bg-gray-900/80 px-3 py-2 text-sm text-gray-100 placeholder-gray-500 focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    </div>
                </div>
                <div class="space-y-5">
                    <div>
                        <p class="mb-3 text-xs font-semibold uppercase tracking-wide text-gray-400">Color tag</p>
                        <div class="grid grid-cols-3 gap-2" id="plannerColorOptions">
                            <button class="planner-color-option rounded-lg border border-gray-700 bg-gray-900/60 px-3 py-2 text-sm font-medium text-gray-300 hover:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500" data-color="none">No color</button>
                            <button class="planner-color-option rounded-lg border border-blue-500/40 bg-blue-600/20 px-3 py-2 text-sm font-medium text-blue-100 hover:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-400" data-color="blue">Blue</button>
                            <button class="planner-color-option rounded-lg border border-emerald-500/40 bg-emerald-600/20 px-3 py-2 text-sm font-medium text-emerald-100 hover:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-400" data-color="green">Green</button>
                            <button class="planner-color-option rounded-lg border border-rose-500/40 bg-rose-600/20 px-3 py-2 text-sm font-medium text-rose-100 hover:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-400" data-color="red">Red</button>
                            <button class="planner-color-option rounded-lg border border-amber-500/40 bg-amber-500/20 px-3 py-2 text-sm font-medium text-amber-100 hover:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-400" data-color="yellow">Yellow</button>
                            <button class="planner-color-option rounded-lg border border-purple-500/40 bg-purple-600/20 px-3 py-2 text-sm font-medium text-purple-100 hover:border-purple-400 focus:outline-none focus:ring-2 focus:ring-purple-400" data-color="purple">Purple</button>
                            <button class="planner-color-option rounded-lg border border-cyan-500/40 bg-cyan-600/20 px-3 py-2 text-sm font-medium text-cyan-100 hover:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-400" data-color="teal">Teal</button>
                        </div>
                    </div>
                    <div>
                        <p class="mb-3 text-xs font-semibold uppercase tracking-wide text-gray-400">Priority</p>
                        <div class="flex flex-col gap-2" id="plannerPriorityOptions">
                            <button class="planner-priority-option flex items-center justify-between rounded-lg border border-rose-500/40 bg-rose-600/20 px-3 py-2 text-sm font-semibold text-rose-100 hover:border-rose-400 focus:outline-none focus:ring-2 focus:ring-rose-400" data-priority="high">
                                <span>High</span>
                                <span class="text-xs uppercase tracking-wide">Focus now</span>
                            </button>
                            <button class="planner-priority-option flex items-center justify-between rounded-lg border border-amber-500/40 bg-amber-500/20 px-3 py-2 text-sm font-semibold text-amber-100 hover:border-amber-400 focus:outline-none focus:ring-2 focus:ring-amber-400" data-priority="medium">
                                <span>Medium</span>
                                <span class="text-xs uppercase tracking-wide">Next up</span>
                            </button>
                            <button class="planner-priority-option flex items-center justify-between rounded-lg border border-emerald-500/40 bg-emerald-600/20 px-3 py-2 text-sm font-semibold text-emerald-100 hover:border-emerald-400 focus:outline-none focus:ring-2 focus:ring-emerald-400" data-priority="low">
                                <span>Low</span>
                                <span class="text-xs uppercase tracking-wide">When ready</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center justify-between border-t border-gray-800 bg-gray-900/80 px-6 py-4">
                <div class="text-xs text-gray-500" id="plannerStatusMessage"></div>
                <div class="flex gap-2">
                    <button id="plannerCancelBtn" class="rounded-lg border border-gray-700 bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-300 hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-600">
                        Cancel
                    </button>
                    <button id="plannerSaveBtn" class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        Save changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Homework Exercise Modal -->
    <div id="exerciseModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white">Add Exercises</h3>
                <button id="closeExerciseModal" class="text-gray-400 hover:text-white">✕</button>
            </div>
            <div class="space-y-3">
                <div class="flex gap-2">
                    <input type="text" id="exerciseInput" placeholder="Exercise name..." class="flex-1 bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 focus:outline-none focus:border-blue-500">
                    <button id="addExerciseBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                        Add
                    </button>
                </div>
                <div id="exerciseList" class="space-y-2 max-h-64 overflow-y-auto"></div>
                <button id="saveExercisesBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                    Save Exercises
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer" class="fixed bottom-5 right-5 z-[100] w-full max-w-sm space-y-3">
        <!-- Toast notifications will be dynamically added here -->
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules from CDN
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, getDoc, setDoc, serverTimestamp, arrayUnion, arrayRemove } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        // TODO: Replace with your Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBpZlB5V3ZIC4snTND51JBqPJlEzsvWpKs",
            authDomain: "study-dashboard-71a54.firebaseapp.com",
            projectId: "study-dashboard-71a54",
            storageBucket: "study-dashboard-71a54.firebasestorage.app",
            messagingSenderId: "92963704725",
            appId: "1:92963704725:web:5f8b09216e09862fb3b09c"
        };
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const loginScreen = document.getElementById('loginScreen');
        const dashboard = document.getElementById('dashboard');
        const loginBtn = document.getElementById('loginBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userPhoto = document.getElementById('userPhoto');
        const userId = document.getElementById('userId');

        // Homework elements
        const homeworkInput = document.getElementById('homeworkInput');
        const addHomeworkBtn = document.getElementById('addHomeworkBtn');
        const homeworkList = document.getElementById('homeworkList');
        const homeworkAdvancedOptions = document.getElementById('homeworkAdvancedOptions');
        const homeworkSettingsSummary = document.getElementById('homeworkSettingsSummary');
        const homeworkPlannerBtn = document.getElementById('homeworkPlannerBtn');
        const homeworkClearSettingsBtn = document.getElementById('homeworkClearSettingsBtn');
        const homeworkQuickDueButtons = document.querySelectorAll('[data-quick-homework-due]');

        // Friends elements
        const friendInput = document.getElementById('friendInput');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const friendsList = document.getElementById('friendsList');

        // Friends' Activity elements
        const friendsActivity = document.getElementById('friendsActivity');
        const combinedTaskList = document.getElementById('combinedTaskList');

        // Side panel elements
        const menuToggle = document.getElementById('menuToggle');
        const sidePanel = document.getElementById('sidePanel');
        const sidePanelOverlay = document.getElementById('sidePanelOverlay');
        const sidePanelCloseBtn = document.getElementById('sidePanelCloseBtn');
        const sidePanelTabButtons = document.querySelectorAll('[data-side-panel-tab]');
        const sidePanelSections = document.querySelectorAll('[data-side-panel-section]');

        // Music links elements
        const musicLinkInput = document.getElementById('musicLinkInput');
        const addMusicLinkBtn = document.getElementById('addMusicLinkBtn');
        const musicLinksList = document.getElementById('musicLinksList');
        const musicLinksEmptyState = document.getElementById('musicLinksEmptyState');

        // Tags elements
        const newTagName = document.getElementById('newTagName');
        const newTagColor = document.getElementById('newTagColor');
        const addTagBtn = document.getElementById('addTagBtn');
        const tagList = document.getElementById('tagList');
        const tagListEmpty = document.getElementById('tagListEmpty');
        const homeworkTagsPicker = document.getElementById('homeworkTagsPicker');

        // Timer elements
        const timerDisplay = document.getElementById('timerDisplay');
        const timerStartBtn = document.getElementById('timerStartBtn');
        const timerPauseBtn = document.getElementById('timerPauseBtn');
        const timerResetBtn = document.getElementById('timerResetBtn');
        const timerStatus = document.getElementById('timerStatus');

        // Exercise Modal elements
        const exerciseModal = document.getElementById('exerciseModal');
        const exerciseInput = document.getElementById('exerciseInput');
        const addExerciseBtn = document.getElementById('addExerciseBtn');
        const exerciseList = document.getElementById('exerciseList');
        const saveExercisesBtn = document.getElementById('saveExercisesBtn');
        const closeExerciseModal = document.getElementById('closeExerciseModal');

        // Task planner modal elements
        const taskPlannerModal = document.getElementById('taskPlannerModal');
        const plannerTitle = document.getElementById('plannerTitle');
        const plannerSubtitle = document.getElementById('plannerSubtitle');
        const plannerDueDate = document.getElementById('plannerDueDate');
        const plannerNotes = document.getElementById('plannerNotes');
        const plannerColorOptions = document.querySelectorAll('.planner-color-option');
        const plannerPriorityOptions = document.querySelectorAll('.planner-priority-option');
        const plannerQuickButtons = document.querySelectorAll('[data-planner-quick]');
        const plannerStatusMessage = document.getElementById('plannerStatusMessage');
        const plannerSaveBtn = document.getElementById('plannerSaveBtn');
        const plannerCancelBtn = document.getElementById('plannerCancelBtn');
        const plannerCloseBtn = document.getElementById('plannerCloseBtn');

        // Calendar integration
        let googleAccessToken = null;
        const connectCalendarBtn = document.getElementById('connectCalendarBtn');
        const calendarStatus = document.getElementById('calendarStatus');
        const upcomingEvents = document.getElementById('upcomingEvents');

        // ============================================
        // UTILITIES
        // ============================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');

            const icons = {
                success: `<svg class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
                error: `<svg class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`,
                info: `<svg class="h-5 w-5 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>`
            };

            const colors = {
                success: 'bg-green-600 border-green-700',
                error: 'bg-red-600 border-red-700',
                info: 'bg-blue-600 border-blue-700'
            };

            toast.className = `flex items-center gap-3 w-full rounded-lg border p-4 text-sm font-semibold text-white shadow-lg transition-all duration-300 transform translate-y-4 opacity-0 ${colors[type] || colors.info}`;
            toast.innerHTML = `
                ${icons[type] || icons.info}
                <span>${message}</span>
            `;
            container.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-4', 'opacity-0');
            }, 10);

            // Animate out and remove after 4 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 4000);
        }

        function formatDueDate(value) {
            if (!value) return null;

            let dateObj = null;

            if (typeof value === 'string') {
                const parsed = new Date(`${value}T00:00:00`);
                if (!isNaN(parsed)) {
                    dateObj = parsed;
                }
            } else if (value instanceof Date) {
                dateObj = value;
            } else if (value?.toDate) {
                dateObj = value.toDate();
            }

            if (!dateObj) return null;

            return dateObj.toLocaleDateString(undefined, {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        const colorBadgeStyles = {
            blue: { label: 'Blue Tag', bg: 'rgba(59, 130, 246, 0.15)', border: 'rgba(59, 130, 246, 0.35)', text: '#bfdbfe', dot: '#60a5fa' },
            green: { label: 'Green Tag', bg: 'rgba(16, 185, 129, 0.15)', border: 'rgba(16, 185, 129, 0.35)', text: '#6ee7b7', dot: '#10b981' },
            red: { label: 'Red Tag', bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.35)', text: '#fca5a5', dot: '#ef4444' },
            yellow: { label: 'Yellow Tag', bg: 'rgba(234, 179, 8, 0.15)', border: 'rgba(234, 179, 8, 0.35)', text: '#fcd34d', dot: '#eab308' },
            purple: { label: 'Purple Tag', bg: 'rgba(168, 85, 247, 0.15)', border: 'rgba(168, 85, 247, 0.35)', text: '#d8b4fe', dot: '#a855f7' },
            teal: { label: 'Teal Tag', bg: 'rgba(13, 148, 136, 0.15)', border: 'rgba(13, 148, 136, 0.35)', text: '#5eead4', dot: '#0d9488' },
            default: { label: 'Tag', bg: 'rgba(75, 85, 99, 0.3)', border: 'rgba(75, 85, 99, 0.45)', text: '#d1d5db', dot: '#9ca3af' }
        };

        const priorityBadgeStyles = {
            high: { label: 'High Priority', bg: 'rgba(248, 113, 113, 0.15)', border: 'rgba(248, 113, 113, 0.35)', text: '#fca5a5' },
            medium: { label: 'Medium Priority', bg: 'rgba(251, 191, 36, 0.15)', border: 'rgba(251, 191, 36, 0.35)', text: '#fcd34d' },
            low: { label: 'Low Priority', bg: 'rgba(52, 211, 153, 0.15)', border: 'rgba(52, 211, 153, 0.35)', text: '#6ee7b7' }
        };

        function getColorBadge(color) {
            if (!color || color === 'none') return '';
            const style = colorBadgeStyles[color] || colorBadgeStyles.default;
            return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-semibold border" style="background-color:${style.bg}; border-color:${style.border}; color:${style.text}">
                <span class="w-2 h-2 rounded-full" style="background-color:${style.dot};"></span>
                ${style.label}
            </span>`;
        }

        function getPriorityBadge(priority) {
            if (!priority) return '';
            const style = priorityBadgeStyles[priority] || priorityBadgeStyles.medium;
            return `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold border" style="background-color:${style.bg}; border-color:${style.border}; color:${style.text}">
                ${style.label}
            </span>`;
        }

        function setupTabGroup(groupName, optionsContainer) {
            const buttons = Array.from(document.querySelectorAll(`[data-tab-group="${groupName}"]`));
            if (buttons.length === 0) return;

            const activeClasses = ['bg-gray-700', 'text-white', 'border-gray-600'];
            const inactiveClasses = ['bg-gray-800', 'text-gray-300', 'border-transparent'];

            const activate = (button) => {
                buttons.forEach((btn) => {
                    btn.classList.remove(...activeClasses, ...inactiveClasses);
                    btn.classList.add(...inactiveClasses);
                });

                button.classList.remove(...inactiveClasses);
                button.classList.add(...activeClasses);

                if (optionsContainer) {
                    if (button.dataset.tab === 'advanced') {
                        optionsContainer.classList.remove('hidden');
                    } else {
                        optionsContainer.classList.add('hidden');
                    }
                }
            };

            buttons.forEach((button) => {
                button.addEventListener('click', () => activate(button));
            });

            const defaultButton = buttons.find(btn => btn.dataset.tab === 'quick') || buttons[0];
            activate(defaultButton);
        }

        setupTabGroup('homework', homeworkAdvancedOptions);

        // ============================================
        // STATE HELPERS
        // ============================================
        const colorNames = {
            none: 'None',
            blue: 'Blue',
            green: 'Green',
            red: 'Red',
            yellow: 'Yellow',
            purple: 'Purple',
            teal: 'Teal'
        };

        const priorityNames = {
            high: 'High',
            medium: 'Medium',
            low: 'Low'
        };

        const defaultTaskSettings = () => ({
            dueDate: null,
            color: 'none',
            priority: 'medium',
            notes: '',
            tags: []
        });

        const taskComposerState = {
            homework: defaultTaskSettings(),
        };

        const settingsSummaries = {
            homework: homeworkSettingsSummary,
        };

        function updateTaskComposerSummary(type) {
            const settings = taskComposerState[type];
            if (!settings || !settingsSummaries[type]) return; // 'type' will always be 'homework' now

            const pieces = [];
            pieces.push(settings.dueDate ? `Due ${formatDueDate(settings.dueDate)}` : 'No due date');
            pieces.push(`Color: ${colorNames[settings.color] || 'Custom'}`);
            pieces.push(`Priority: ${priorityNames[settings.priority] || 'Medium'}`);

            if (settings.notes?.trim()) {
                pieces.push('Notes ready');
            }
            if (settings.tags?.length) {
                pieces.push(`${settings.tags.length} tag${settings.tags.length > 1 ? 's' : ''}`);
            }

            settingsSummaries[type].innerHTML = pieces.map(piece => `<span>${piece}</span>`).join(' • ');
        }

        function applyQuickDueDate(type, action) {
            const settings = taskComposerState[type];
            if (!settings) return;

            if (action === 'clear') {
                settings.dueDate = null;
            } else {
                const date = new Date();
                if (action === 'tomorrow') {
                    date.setDate(date.getDate() + 1);
                } else if (action === 'week') {
                    date.setDate(date.getDate() + 7);
                }
                settings.dueDate = date.toISOString().slice(0, 10);
            }

            updateTaskComposerSummary(type);
        }

        function resetTaskComposerSettings(type) {
            taskComposerState[type] = defaultTaskSettings();
            updateTaskComposerSummary(type);
        }

        updateTaskComposerSummary('homework');

        function bindQuickDueButtons(buttons, type) {
            buttons.forEach((button) => {
                button.addEventListener('click', () => {
                    const action = button.dataset.quickHomeworkDue;
                    if (!action) return;
                    applyQuickDueDate(type, action);
                });
            });
        }

        bindQuickDueButtons(homeworkQuickDueButtons, 'homework');

        // ============================================
        // TAGS MANAGEMENT
        // ============================================
        let userTags = [];

        function renderTagChip(tag, withRemove = false) {
            const style = colorBadgeStyles[tag.color] || colorBadgeStyles.default;
            return `
                <span class="inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-semibold border" style="background-color:${style.bg}; border-color:${style.border}; color:${style.text}">
                    <span class="w-2 h-2 rounded-full" style="background-color:${style.dot};"></span>
                    ${tag.name}
                    ${withRemove ? `<button class="ml-1 rounded bg-transparent hover:text-red-300" data-remove-tag="${tag.id}" title="Remove">×</button>` : ''}
                </span>
            `;
        }

        function renderTagList() {
            if (!tagList) return;
            tagList.innerHTML = '';
            if (!userTags.length) {
                tagListEmpty.classList.remove('hidden');
                return;
            }
            tagListEmpty.classList.add('hidden');
            userTags.forEach(tag => {
                const wrapper = document.createElement('div');
                wrapper.innerHTML = renderTagChip(tag, true);
                tagList.appendChild(wrapper.firstElementChild);
            });
        }

        function renderTagsPicker(container, type) {
            if (!container) return;
            container.innerHTML = '';
            userTags.forEach(tag => {
                const style = colorBadgeStyles[tag.color] || colorBadgeStyles.default;
                const isSelected = (taskComposerState[type].tags || []).some(t => t.id === tag.id);
                const el = document.createElement('button');
                el.className = `inline-flex items-center gap-2 px-2 py-1 rounded text-xs font-semibold border ${isSelected ? '' : ''}`;
                el.setAttribute('style', `background-color:${style.bg}; border-color:${style.border}; color:${style.text}`);
                el.innerHTML = `<span class="w-2 h-2 rounded-full" style="background-color:${style.dot};"></span>${tag.name}`;
                el.addEventListener('click', () => {
                    const current = taskComposerState[type].tags || [];
                    const exists = current.some(t => t.id === tag.id);
                    taskComposerState[type].tags = exists
                        ? current.filter(t => t.id !== tag.id)
                        : [...current, tag]; // store full tag object to embed into task
                    renderTagsPicker(container, type);
                    updateTaskComposerSummary(type);
                });
                container.appendChild(el);
            });
            if (!userTags.length) {
                container.innerHTML = '<p class="text-xs text-gray-500">No tags yet.</p>';
            }
        }

        async function saveUserTags(tags) {
            if (!currentUser) return;
            const userRef = doc(db, 'users', currentUser.uid);
            await updateDoc(userRef, { tags });
        }

        if (addTagBtn) {
            addTagBtn.addEventListener('click', async () => {
                const name = (newTagName?.value || '').trim();
                const color = newTagColor?.value || 'blue';
                if (!name || !currentUser) return;
                const id = `${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
                userTags.push({ id, name, color });
                renderTagList();
                renderTagsPicker(homeworkTagsPicker, 'homework'); // Only one picker to update now
                newTagName.value = '';
                try {
                    await saveUserTags(userTags);
                    showToast('Tag created successfully!');
                } catch (e) {
                    console.error('Failed to save tag:', e);
                }
            });
        }

        if (tagList) {
            tagList.addEventListener('click', async (e) => {
                const btn = e.target.closest('[data-remove-tag]');
                if (!btn) return;
                const id = btn.getAttribute('data-remove-tag');
                userTags = userTags.filter(t => t.id !== id);
                renderTagList();
                renderTagsPicker(homeworkTagsPicker, 'homework'); // Only one picker to update now
                try {
                    await saveUserTags(userTags);
                    showToast('Tag removed.', 'info');
                } catch (e2) {
                    console.error('Failed to remove tag:', e2);
                    showToast('Failed to remove tag.', 'error');
                }
            });
        }
        if (homeworkPlannerBtn) {
            homeworkPlannerBtn.addEventListener('click', () => {
                openTaskPlanner({ mode: 'create', type: 'homework' });
            });
        }

        if (homeworkClearSettingsBtn) {
            homeworkClearSettingsBtn.addEventListener('click', () => resetTaskComposerSettings('homework'));
        }

        // ============================================
        // SCROLL LOCK MANAGEMENT
        // ============================================
        let overlayStack = 0;

        function lockScroll() {
            overlayStack += 1;
            document.body.classList.add('overflow-hidden');
        }

        function unlockScroll() {
            overlayStack = Math.max(overlayStack - 1, 0);
            if (overlayStack === 0) {
                document.body.classList.remove('overflow-hidden');
            }
        }

        // ============================================
        // SIDE PANEL
        // ============================================
        const sidePanelActiveClasses = ['border-blue-500/60', 'bg-blue-600/20', 'text-blue-200'];
        const sidePanelInactiveClasses = ['border-transparent', 'bg-gray-800', 'text-gray-300'];
        let isSidePanelOpen = false;

        function setSidePanelTab(tabName = 'friends') {
            sidePanelTabButtons.forEach((button) => {
                const isActive = button.dataset.sidePanelTab === tabName;
                button.classList.remove(...sidePanelActiveClasses, ...sidePanelInactiveClasses);
                button.classList.add(...(isActive ? sidePanelActiveClasses : sidePanelInactiveClasses));
            });

            sidePanelSections.forEach((section) => {
                section.classList.toggle('hidden', section.dataset.sidePanelSection !== tabName);
            });
        }

        function openSidePanel(defaultTab = 'friends') {
            if (!sidePanel || !sidePanelOverlay) return;
            setSidePanelTab(defaultTab);
            sidePanel.classList.remove('translate-x-full');
            sidePanelOverlay.classList.remove('hidden');
            isSidePanelOpen = true;
            lockScroll();
        }

        function closeSidePanel() {
            if (!sidePanel || !sidePanelOverlay || !isSidePanelOpen) return;
            sidePanel.classList.add('translate-x-full');
            sidePanelOverlay.classList.add('hidden');
            isSidePanelOpen = false;
            unlockScroll();
        }

        if (menuToggle) {
            menuToggle.addEventListener('click', () => openSidePanel('friends'));
        }

        if (sidePanelCloseBtn) {
            sidePanelCloseBtn.addEventListener('click', closeSidePanel);
        }

        if (sidePanelOverlay) {
            sidePanelOverlay.addEventListener('click', closeSidePanel);
        }

        sidePanelTabButtons.forEach((button) => {
            button.addEventListener('click', () => setSidePanelTab(button.dataset.sidePanelTab));
        });

        setSidePanelTab('friends');

        // ============================================
        // MUSIC LINKS (LOCAL STORAGE)
        // ============================================
        const MUSIC_LINKS_STORAGE_KEY = 'studyhub_music_links';
        let musicLinks = [];

        function loadMusicLinks() {
            if (!musicLinksList) return;
            try {
                const stored = localStorage.getItem(MUSIC_LINKS_STORAGE_KEY);
                musicLinks = stored ? JSON.parse(stored) : [];
                if (!Array.isArray(musicLinks)) {
                    musicLinks = [];
                }
            } catch (error) {
                console.warn('Failed to load music links from storage:', error);
                musicLinks = [];
            }
        }

        function saveMusicLinks() {
            try {
                localStorage.setItem(MUSIC_LINKS_STORAGE_KEY, JSON.stringify(musicLinks));
            } catch (error) {
                console.warn('Failed to save music links:', error);
            }
        }

        function renderMusicLinks() {
            if (!musicLinksList || !musicLinksEmptyState) return;

            musicLinksList.innerHTML = '';
            if (musicLinks.length === 0) {
                musicLinksEmptyState.classList.remove('hidden');
                return;
            }

            musicLinksEmptyState.classList.add('hidden');

            musicLinks.forEach((link, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between gap-3 rounded-lg border border-gray-700 bg-gray-900/60 px-3 py-2';
                li.innerHTML = `
                    <a href="${link}" target="_blank" rel="noopener" class="truncate text-blue-300 hover:text-blue-200 hover:underline">${link}</a>
                    <button class="rounded-md border border-gray-600 bg-gray-800 px-2 py-1 text-xs font-semibold uppercase tracking-wide text-gray-300 hover:border-red-500 hover:text-red-300 focus:outline-none focus:ring-2 focus:ring-red-500" data-remove-music="${index}">
                        Remove
                    </button>
                `;
                musicLinksList.appendChild(li);
            });
        }

        function addMusicLink(url) {
            try {
                const parsed = new URL(url);
                if (!['http:', 'https:'].includes(parsed.protocol)) {
                    throw new Error('Invalid protocol');
                }
            } catch (error) {
                if (musicLinksEmptyState) {
                    musicLinksEmptyState.classList.remove('hidden');
                    musicLinksEmptyState.textContent = 'Please provide a valid https:// link.';
                }
                return false;
            }

            if (musicLinks.includes(url)) {
                if (musicLinksEmptyState) {
                    musicLinksEmptyState.classList.remove('hidden');
                    musicLinksEmptyState.textContent = 'Link already saved.';
                }
                return false;
            }

            musicLinks.push(url);
            saveMusicLinks();
            renderMusicLinks();
            if (musicLinksEmptyState) {
                musicLinksEmptyState.textContent = 'No links yet. Add your favorite playlists above.';
            }
            return true;
        }

        if (addMusicLinkBtn && musicLinkInput && musicLinksList) {
            addMusicLinkBtn.addEventListener('click', () => {
                const value = musicLinkInput.value.trim();
                if (!value) {
                    musicLinkInput.focus();
                    return;
                }
                if (addMusicLink(value)) {
                    musicLinkInput.value = '';
                }
            });

            musicLinkInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addMusicLinkBtn.click();
                }
            });

            musicLinksList.addEventListener('click', (event) => {
                const button = event.target.closest('[data-remove-music]');
                if (!button) return;
                const index = parseInt(button.dataset.removeMusic, 10);
                if (Number.isNaN(index)) return;
                musicLinks.splice(index, 1);
                saveMusicLinks();
                renderMusicLinks();
                if (musicLinks.length === 0 && musicLinksEmptyState) {
                    musicLinksEmptyState.classList.remove('hidden');
                    musicLinksEmptyState.textContent = 'No links yet. Add your favorite playlists above.';
                }
            });

            loadMusicLinks();
            renderMusicLinks();
        }

        // ============================================
        // TASK PLANNER MODAL
        // ============================================
        let plannerContext = null;
        let plannerDraft = null;

        function updatePlannerColorSelection(selected) {
            plannerColorOptions.forEach((button) => {
                const isActive = button.dataset.color === selected;
                button.classList.toggle('ring-2', isActive);
                button.classList.toggle('ring-offset-2', isActive);
                button.classList.toggle('ring-offset-gray-900', isActive);
                button.classList.toggle('ring-blue-400', isActive && selected === 'blue');
                button.classList.toggle('ring-emerald-400', isActive && selected === 'green');
                button.classList.toggle('ring-rose-400', isActive && selected === 'red');
                button.classList.toggle('ring-amber-400', isActive && selected === 'yellow');
                button.classList.toggle('ring-purple-400', isActive && selected === 'purple');
                button.classList.toggle('ring-cyan-400', isActive && selected === 'teal');
                if (selected === 'none' && isActive) {
                    button.classList.add('ring-gray-400');
                } else {
                    button.classList.remove('ring-gray-400');
                }
            });
        }

        function updatePlannerPrioritySelection(selected) {
            plannerPriorityOptions.forEach((button) => {
                const isActive = button.dataset.priority === selected;
                button.classList.toggle('ring-2', isActive);
                button.classList.toggle('ring-offset-2', isActive);
                button.classList.toggle('ring-offset-gray-900', isActive);
            });
        }

        function updatePlannerInputs() {
            if (!plannerDraft) return;
            plannerDueDate.value = plannerDraft.dueDate || '';
            plannerNotes.value = plannerDraft.notes || '';
            updatePlannerColorSelection(plannerDraft.color || 'none');
            updatePlannerPrioritySelection(plannerDraft.priority || 'medium');
            plannerStatusMessage.textContent = '';
            plannerSaveBtn.disabled = false;
        }

        function openTaskPlanner(context) {
            plannerContext = context;
            const baseSettings = context.mode === 'edit'
                ? {
                    dueDate: context.taskData?.dueDate || null,
                    color: context.taskData?.color || 'none',
                    priority: context.taskData?.priority || 'medium',
                    notes: context.taskData?.notes || ''
                }
                : { ...taskComposerState[context.type] };

            plannerDraft = {
                dueDate: baseSettings.dueDate || null,
                color: baseSettings.color || 'none',
                priority: baseSettings.priority || 'medium',
                notes: baseSettings.notes || ''
            };

            plannerTitle.textContent = context.mode === 'edit' ? 'Edit task details' : 'Task planner';
            plannerSubtitle.textContent = context.type === 'homework' ? 'Homework task' : 'Revision task';

            updatePlannerInputs();

            if (taskPlannerModal) {
                taskPlannerModal.classList.remove('hidden');
                taskPlannerModal.classList.add('flex');
                lockScroll();
            }
        }

        function closeTaskPlanner() {
            if (!plannerContext) return;
            plannerContext = null;
            plannerDraft = null;
            if (taskPlannerModal) {
                taskPlannerModal.classList.add('hidden');
                taskPlannerModal.classList.remove('flex');
                unlockScroll();
            }
        }

        if (plannerDueDate) {
            plannerDueDate.addEventListener('change', () => {
                if (!plannerDraft) return;
                plannerDraft.dueDate = plannerDueDate.value || null;
            });
        }

        if (plannerNotes) {
            plannerNotes.addEventListener('input', () => {
                if (!plannerDraft) return;
                plannerDraft.notes = plannerNotes.value;
            });
        }

        plannerColorOptions.forEach((button) => {
            button.addEventListener('click', () => {
                if (!plannerDraft) return;
                plannerDraft.color = button.dataset.color;
                updatePlannerColorSelection(plannerDraft.color);
            });
        });

        plannerPriorityOptions.forEach((button) => {
            button.addEventListener('click', () => {
                if (!plannerDraft) return;
                plannerDraft.priority = button.dataset.priority;
                updatePlannerPrioritySelection(plannerDraft.priority);
            });
        });

        plannerQuickButtons.forEach((button) => {
            button.addEventListener('click', () => {
                if (!plannerDraft) return;
                const action = button.dataset.plannerQuick;
                if (action === 'clear') {
                    plannerDraft.dueDate = null;
                } else {
                    const date = new Date();
                    if (action === 'tomorrow') {
                        date.setDate(date.getDate() + 1);
                    } else if (action === 'week') {
                        date.setDate(date.getDate() + 7);
                    }
                    plannerDraft.dueDate = date.toISOString().slice(0, 10);
                }
                updatePlannerInputs();
            });
        });

        if (plannerCancelBtn) {
            plannerCancelBtn.addEventListener('click', closeTaskPlanner);
        }

        if (plannerCloseBtn) {
            plannerCloseBtn.addEventListener('click', closeTaskPlanner);
        }

        if (taskPlannerModal) {
            taskPlannerModal.addEventListener('click', (event) => {
                if (event.target === taskPlannerModal) {
                    closeTaskPlanner();
                }
            });
        }

        if (plannerSaveBtn) {
            plannerSaveBtn.addEventListener('click', async () => {
                if (!plannerContext || !plannerDraft) return;

                const payload = {
                    dueDate: plannerDraft.dueDate || null,
                    color: plannerDraft.color === 'none' ? null : plannerDraft.color,
                    priority: plannerDraft.priority || 'medium',
                    notes: plannerDraft.notes?.trim() || ''
                };

                plannerSaveBtn.disabled = true;
                plannerStatusMessage.textContent = plannerContext.mode === 'edit' ? 'Saving changes…' : 'Updating defaults…';

                if (plannerContext.mode === 'edit') {
                    try {
                        const taskRef = doc(db, 'tasks', plannerContext.taskId);
                        await updateDoc(taskRef, payload);
                        plannerStatusMessage.textContent = 'Task updated.';
                        setTimeout(() => closeTaskPlanner(), 350);
                    } catch (error) {
                showToast('Failed to update task.', 'error');
                        console.error('Error updating task:', error);
                        plannerStatusMessage.textContent = 'Failed to update task. Please try again.';
                        plannerSaveBtn.disabled = false;
                    }
                } else {
                    const targetState = taskComposerState[plannerContext.type];
                    if (targetState) {
                        targetState.dueDate = payload.dueDate;
                        targetState.color = payload.color || 'none';
                        targetState.priority = payload.priority;
                        targetState.notes = payload.notes;
                        updateTaskComposerSummary(plannerContext.type);
                    }
                    plannerStatusMessage.textContent = 'Defaults updated.';
                    showToast('Default settings have been updated.', 'info');
                    setTimeout(() => closeTaskPlanner(), 250);
                }
            });
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (plannerContext) {
                    closeTaskPlanner();
                    return;
                }
                if (isSidePanelOpen) {
                    closeSidePanel();
                }
            }
        });

        // ============================================
        // AUTHENTICATION
        // ============================================
        let currentUser = null;
        let currentTaskId = null; // For exercise modal

        // Monitor authentication state
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                dashboard.classList.remove('hidden');
                
                // Update profile
                userName.textContent = user.displayName || 'User';
                userEmail.textContent = user.email;
                userPhoto.src = user.photoURL || '';
                userId.textContent = user.uid;

                // Initialize user document in Firestore
                await initializeUserDocument(user);

                // Load all data
                loadAllTasks();
                loadFriends();
                loadFriendsActivity();
                // Load tags
                const userRef = doc(db, 'users', currentUser.uid);
                onSnapshot(userRef, (snap) => {
                    if (snap.exists()) {
                        userTags = snap.data().tags || [];
                        renderTagList();
                        renderTagsPicker(homeworkTagsPicker, 'homework'); // Only one picker to update
                    }
                });
            } else {
                currentUser = null;
                loginScreen.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        // Extend Google provider with Calendar scopes
        googleProvider.addScope('https://www.googleapis.com/auth/calendar.readonly');
        googleProvider.addScope('https://www.googleapis.com/auth/calendar.events');

        // Login with Google
        loginBtn.addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const cred = GoogleAuthProvider.credentialFromResult(result);
                googleAccessToken = cred?.accessToken || null;
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed: ' + error.message, 'error');
            }
        });

        // Sign out
        signOutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('You have been signed out.', 'info');
            } catch (error) {
                console.error('Sign out error:', error);
            }
        });

        // ============================================
        // GOOGLE CALENDAR INTEGRATION
        // ============================================
        async function ensureCalendarAccess() {
            if (googleAccessToken) return googleAccessToken;
            try {
                const result = await signInWithPopup(auth, googleProvider);
                const cred = GoogleAuthProvider.credentialFromResult(result);
                googleAccessToken = cred?.accessToken || null;
                return googleAccessToken;
            } catch (error) {
                console.error('Calendar connect failed:', error);
                throw error;
            }
        }

        function setCalendarStatus(text) {
            if (calendarStatus) calendarStatus.textContent = text || '';
        }

        function renderEvents(events = []) {
            if (!upcomingEvents) return;
            if (!events.length) {
                upcomingEvents.innerHTML = '<p class="text-sm text-gray-400">No upcoming events.</p>';
                return;
            }
            upcomingEvents.innerHTML = events.map(ev => {
                const start = ev.start?.dateTime || ev.start?.date || '';
                const when = start ? formatDueDate(start.slice(0, 10)) : '';
                return `
                    <div class="rounded border border-gray-700 bg-gray-800/60 p-2">
                        <p class="text-white text-sm font-medium">${ev.summary || '(No title)'}</p>
                        <p class="text-xs text-gray-400">${when}</p>
                    </div>
                `;
            }).join('');
        }

        async function fetchUpcomingEvents() {
            if (!upcomingEvents) return;
            try {
                setCalendarStatus('Loading events…');
                const token = await ensureCalendarAccess();
                const now = new Date().toISOString();
                const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${encodeURIComponent(now)}&singleEvents=true&maxResults=10&orderBy=startTime`;
                const res = await fetch(url, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message || 'Failed to fetch events');
                renderEvents(data.items || []);
                setCalendarStatus('');
            } catch (e) {
                console.error(e);
                setCalendarStatus('Could not load events.');
            }
        }

        async function addTaskToCalendar(task) {
            try {
                const token = await ensureCalendarAccess();
                // If no due date, open planner to set one first
                if (!task.dueDate) {
                    openTaskPlanner({ mode: 'edit', type: task.type || 'homework', taskId: task.id, taskData: task });
                    setCalendarStatus('Set a due date, then try again.');
                    showToast('Please set a due date for the task first.', 'info');
                    return;
                }
                // Create all-day event on due date
                const startDate = typeof task.dueDate === 'string' ? task.dueDate : (task.dueDate?.toDate?.() ? task.dueDate.toDate().toISOString().slice(0,10) : null);
                if (!startDate) {
                    setCalendarStatus('Invalid due date for this task.');
                    return;
                }
                const eventPayload = {
                    summary: task.title,
                    description: `${task.type === 'homework' ? 'Homework' : 'Revision'}${task.notes ? '\\n\\nNotes: ' + task.notes : ''}`,
                    start: { date: startDate },
                    end: { date: startDate }
                };
                const res = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: {
                        Authorization: `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventPayload)
                });
                const data = await res.json();
                if (data.error) throw new Error(data.error.message || 'Failed to create event');
                setCalendarStatus('Event added to your calendar.');
                showToast('Task added to Google Calendar!');
                fetchUpcomingEvents();
            } catch (e) {
                console.error('Add to calendar failed:', e);
                setCalendarStatus('Could not add to calendar.');
                showToast('Could not add task to calendar.', 'error');
            }
        }

        if (connectCalendarBtn) {
            connectCalendarBtn.addEventListener('click', async () => {
                try {
                    setCalendarStatus('Connecting…');
                    await ensureCalendarAccess();
                    setCalendarStatus('');
                    showToast('Google Calendar connected successfully!');
                    fetchUpcomingEvents();
                } catch {
                    showToast('Failed to connect Google Calendar.', 'error');
                    setCalendarStatus('Connection failed.');
                }
            });
        }

        // ============================================
        // FIRESTORE: USER DOCUMENT INITIALIZATION
        // ============================================
        async function initializeUserDocument(user) {
            const userRef = doc(db, 'users', user.uid);
            const userSnap = await getDoc(userRef);
            
            if (!userSnap.exists()) {
                // Create user document if it doesn't exist
                await setDoc(userRef, {
                    email: user.email,
                    displayName: user.displayName || 'User',
                    friends: []
                });
            }
        }

        // ============================================
        // TASKS (Combined)
        // ============================================
        function renderCombinedTask(task, container) {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'bg-gray-700 rounded p-3';
            
            const isCompleted = task.completed || false;
            const formattedDueDate = formatDueDate(task.dueDate);
            const metadataPieces = [];
            const colorBadge = getColorBadge(task.color);
            const priorityBadge = task.priority ? getPriorityBadge(task.priority) : '';
            const tagsBadges = (task.tags || []).map(tag => renderTagChip(tag, false)).join('');
            
            if (formattedDueDate) {
                metadataPieces.push(`<span class="text-xs text-gray-400">Due ${formattedDueDate}</span>`);
            }
            if (colorBadge) {
                metadataPieces.push(colorBadge);
            }
            if (priorityBadge) {
                metadataPieces.push(priorityBadge);
            }
            
            taskDiv.innerHTML = `
                <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:gap-4">
                    <div class="flex flex-1 items-start gap-3">
                        <input type="checkbox" ${isCompleted ? 'checked' : ''} 
                               class="mt-1 h-4 w-4 flex-shrink-0 rounded border-gray-500 bg-gray-600 text-green-500 focus:ring-green-500"
                               data-task-id="${task.id}">
                        <div class="flex-1">
                            <span class="${isCompleted ? 'line-through text-gray-400' : 'text-white'} font-medium">${task.title}</span>
                            ${metadataPieces.length || tagsBadges ? `<div class="mt-2 flex flex-wrap items-center gap-2">${metadataPieces.join('')}${tagsBadges ? (metadataPieces.length ? '' : '') + tagsBadges : ''}</div>` : ''}
                            ${task.notes ? `<div class="mt-3 rounded-lg border border-gray-600/60 bg-gray-800/50 p-3 text-sm text-gray-200">${task.notes}</div>` : ''}
                        </div>
                    </div>
                    <div class="flex shrink-0 flex-row gap-2 sm:flex-col sm:items-end">
                        <button class="rounded-lg border border-blue-500/40 bg-blue-600/20 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-blue-200 hover:bg-blue-600/30 focus:outline-none focus:ring-2 focus:ring-blue-500" data-edit-task-generic="${task.id}">
                            Edit
                        </button>
                        <button class="rounded-lg border border-emerald-500/40 bg-emerald-600/20 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-emerald-200 hover:bg-emerald-600/30 focus:outline-none focus:ring-2 focus:ring-emerald-500" data-add-to-calendar="${task.id}">
                            Add to Calendar
                        </button>
                        <button class="rounded-lg border border-purple-500/40 bg-purple-600/20 px-3 py-2 text-xs font-semibold uppercase tracking-wide text-purple-200 hover:bg-purple-600/30 focus:outline-none focus:ring-2 focus:ring-purple-500" data-task-id="${task.id}" data-add-exercise>
                            ${task.exercises && task.exercises.length ? 'Edit Exercises' : 'Add Exercises'}
                        </button>
                    </div>
                </div>
            `;

            const checkbox = taskDiv.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', async (e) => {
                const taskRef = doc(db, 'tasks', task.id);
                await updateDoc(taskRef, {
                    completed: e.target.checked
                });
            });

            const editGenericBtn = taskDiv.querySelector('[data-edit-task-generic]');
            if (editGenericBtn) {
                editGenericBtn.addEventListener('click', () => {
                    openTaskPlanner({
                        mode: 'edit',
                        type: task.type || 'homework',
                        taskId: task.id,
                        taskData: task
                    });
                });
            }

            const addToCalendarBtn = taskDiv.querySelector('[data-add-to-calendar]');
            if (addToCalendarBtn) {
                addToCalendarBtn.addEventListener('click', () => addTaskToCalendar(task));
            }

            const addExerciseBtn = taskDiv.querySelector('[data-add-exercise]');
            if (addExerciseBtn) {
                addExerciseBtn.addEventListener('click', () => {
                    currentTaskId = task.id;
                    exerciseList.innerHTML = '';
                    (task.exercises || []).forEach((exercise, idx) => {
                        addExerciseToModal(exercise.text, idx);
                    });
                    exerciseModal.classList.remove('hidden');
                });
            }

            container.appendChild(taskDiv);
        }

        function loadAllTasks() {
            if (!currentUser) return;

            const q = query(
                collection(db, 'tasks'),
                where('userId', '==', currentUser.uid)
            );

            onSnapshot(q, (snapshot) => {
                if (!combinedTaskList) return;
                combinedTaskList.innerHTML = '';

                const items = [];
                snapshot.forEach((docSnap) => {
                    items.push({ id: docSnap.id, ...docSnap.data() });
                });

                // Sort by createdAt desc
                items.sort((a, b) => {
                    const aTime = a.createdAt?.toMillis?.() || 0;
                    const bTime = b.createdAt?.toMillis?.() || 0;
                    return bTime - aTime;
                });

                items.forEach((task) => renderCombinedTask(task, combinedTaskList));

                if (items.length === 0) {
                    combinedTaskList.innerHTML = '<p class="text-sm text-gray-400">No tasks yet.</p>';
                }
            });
        }

        // Add homework task
        addHomeworkBtn.addEventListener('click', async () => {
            const title = homeworkInput.value.trim();
            if (!title || !currentUser) return;

            const settings = taskComposerState.homework;

            try {
                await addDoc(collection(db, 'tasks'), {
                    title: title,
                    type: 'homework', // This is now the only type
                    completed: false,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp(),
                    exercises: [],
                    dueDate: settings.dueDate || null,
                    color: settings.color === 'none' ? null : settings.color,
                    priority: settings.priority || 'medium',
                    notes: settings.notes?.trim() || '',
                    tags: (settings.tags || []).map(t => ({ id: t.id, name: t.name, color: t.color }))
                });
                homeworkInput.value = '';
                if (taskComposerState.homework.notes) {
                    taskComposerState.homework.notes = '';
                    updateTaskComposerSummary('homework');
                }
                showToast('Task added successfully!');
            } catch (error) {
                console.error('Error adding homework:', error);
                showToast('Failed to add task.', 'error');
            }
        });

        homeworkInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addHomeworkBtn.click();
            }
        });

        // ============================================
        // FRIENDS
        // ============================================
        function loadFriends() {
            if (!currentUser) return;

            const userRef = doc(db, 'users', currentUser.uid);
            onSnapshot(userRef, async (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.data();
                    const friends = userData.friends || [];
                    
                    if (friends.length === 0) {
                        friendsList.innerHTML = '<p class="text-sm text-gray-400">No friends yet. Add a friend by their User ID!</p>';
                        return;
                    }

                    friendsList.innerHTML = '';
                    
                    // Fetch friend details
                    for (const friendUid of friends) {
                        try {
                            const friendDoc = await getDoc(doc(db, 'users', friendUid));
                            if (friendDoc.exists()) {
                                const friendData = friendDoc.data();
                                const friendDiv = document.createElement('div');
                                friendDiv.className = 'bg-gray-700 rounded p-2 flex items-center justify-between';
                                friendDiv.innerHTML = `
                                    <div>
                                        <p class="text-white font-medium">${friendData.displayName || 'Unknown'}</p>
                                        <p class="text-xs text-gray-400">${friendData.email || friendUid}</p>
                                    </div>
                                    <button class="text-red-400 hover:text-red-300 text-sm" data-remove-friend="${friendUid}">Remove</button>
                                `;
                                
                                const removeBtn = friendDiv.querySelector('[data-remove-friend]');
                                removeBtn.addEventListener('click', async () => {
                                    await removeFriend(friendUid);
                                });
                                
                                friendsList.appendChild(friendDiv);
                            }
                        } catch (error) {
                            console.error('Error loading friend:', error);
                        }
                    }
                }
            });
        }

        // Add friend
        addFriendBtn.addEventListener('click', async () => {
            const friendUid = friendInput.value.trim();
            if (!friendUid || !currentUser) return;

            if (friendUid === currentUser.uid) {
                showToast('You cannot add yourself as a friend!', 'error');
                return;
            }

            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    friends: arrayUnion(friendUid)
                });
                friendInput.value = '';
                showToast('Friend added successfully!');
            } catch (error) {
                console.error('Error adding friend:', error);
                showToast('Failed to add friend. Check the User ID.', 'error');
            }
        });

        friendInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addFriendBtn.click();
            }
        });

        // Remove friend
        async function removeFriend(friendUid) {
            if (!currentUser) return;
            
            try {
                const userRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userRef, {
                    friends: arrayRemove(friendUid)
                });
                showToast('Friend removed.', 'info');
            } catch (error) {
                console.error('Error removing friend:', error);
                showToast('Failed to remove friend.', 'error');
            }
        }

        // ============================================
        // FRIENDS' ACTIVITY
        // ============================================
        function loadFriendsActivity() {
            if (!currentUser) return;

            const userRef = doc(db, 'users', currentUser.uid);
            onSnapshot(userRef, async (snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.data();
                    const friends = userData.friends || [];
                    
                    if (friends.length === 0) {
                        friendsActivity.innerHTML = '<p class="text-sm text-gray-400">No activity to show. Add friends to see their progress!</p>';
                        return;
                    }

                    // Query tasks from all friends
                    // Note: Firestore 'in' queries are limited to 10 items
                    // For more friends, we'd need to batch queries
                    const friendChunks = [];
                    for (let i = 0; i < friends.length; i += 10) {
                        friendChunks.push(friends.slice(i, i + 10));
                    }

                    friendsActivity.innerHTML = '';

                    for (const chunk of friendChunks) {
                        const q = query(
                            collection(db, 'tasks'),
                            where('userId', 'in', chunk)
                        );

                        onSnapshot(q, async (snapshot) => {
                            if (snapshot.empty && friendsActivity.innerHTML === '') {
                                friendsActivity.innerHTML = '<p class="text-sm text-gray-400">No tasks from friends yet.</p>';
                                return;
                            }

                            // Clear and rebuild activity list
                            const existingItems = [];
                            snapshot.forEach((docSnap) => {
                                const task = { id: docSnap.id, ...docSnap.data() };
                                existingItems.push(task);
                            });

                            // Get friend names
                            const activityItems = await Promise.all(
                                existingItems.map(async (task) => {
                                    try {
                                        const friendDoc = await getDoc(doc(db, 'users', task.userId));
                                        const friendData = friendDoc.exists() ? friendDoc.data() : null;
                                        return {
                                            ...task,
                                            friendName: friendData?.displayName || 'Unknown'
                                        };
                                    } catch (error) {
                                        return { ...task, friendName: 'Unknown' };
                                    }
                                })
                            );

                            // Sort by creation time (newest first)
                            activityItems.sort((a, b) => {
                                const aTime = a.createdAt?.toMillis() || 0;
                                const bTime = b.createdAt?.toMillis() || 0;
                                return bTime - aTime;
                            });

                            friendsActivity.innerHTML = activityItems.map(item => {
                                const statusText = item.completed ? 'completed' : 'is working on';
                                const formattedDueDate = formatDueDate(item.dueDate);
                                const metadataPieces = [];
                                const colorBadge = getColorBadge(item.color);
                                const priorityBadge = item.priority ? getPriorityBadge(item.priority) : '';
                                const tagBadges = (item.tags || []).map(tag => renderTagChip(tag, false)).join('');
                                metadataPieces.push(`<span>📚 Task</span>`);
                                if (formattedDueDate) {
                                    metadataPieces.push(`<span>Due ${formattedDueDate}</span>`);
                                }
                                if (colorBadge) {
                                    metadataPieces.push(colorBadge);
                                }
                                if (priorityBadge) {
                                    metadataPieces.push(priorityBadge);
                                }

                                return `
                                    <div class="bg-gray-700 rounded p-3 space-y-1">
                                        <p class="text-white">
                                            <span class="font-semibold text-blue-400">${item.friendName}</span>
                                            ${statusText}
                                            <span class="font-medium">${item.title}</span>
                                        </p>
                                        <div class="flex flex-wrap gap-2 text-xs text-gray-400">
                                            ${metadataPieces.join('')}${tagBadges}
                                        </div>
                                    </div>
                                `;
                            }).join('');

                            if (friendsActivity.innerHTML === '') {
                                friendsActivity.innerHTML = '<p class="text-sm text-gray-400">No tasks from friends yet.</p>';
                            }
                        });
                    }
                }
            });
        }

        // ============================================
        // STUDY TIMER (POMODORO)
        // ============================================
        let timerInterval = null;
        let timerSeconds = 25 * 60; // 25 minutes in seconds
        let isBreak = false;
        let isRunning = false;

        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer() {
            if (isRunning) return;
            
            isRunning = true;
            timerStatus.textContent = isBreak ? 'Break time!' : 'Study time!';
            
            timerInterval = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();

                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    
                    if (!isBreak) {
                        // Switch to break
                        isBreak = true;
                        timerSeconds = 5 * 60; // 5 minutes break
                        timerStatus.textContent = 'Break time! Take a rest.';
                        updateTimerDisplay();
                        // Auto-start break timer
                        setTimeout(() => {
                            startTimer();
                        }, 1000);
                    } else {
                        // Break finished, reset to study
                        isBreak = false;
                        timerSeconds = 25 * 60;
                        timerStatus.textContent = 'Break finished! Ready for another session.';
                        updateTimerDisplay();
                    }
                }
            }, 1000);
        }

        function pauseTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                isRunning = false;
                timerStatus.textContent = isBreak ? 'Break paused' : 'Study paused';
            }
        }

        function resetTimer() {
            pauseTimer();
            isBreak = false;
            timerSeconds = 25 * 60;
            timerStatus.textContent = 'Ready to start';
            updateTimerDisplay();
        }

        timerStartBtn.addEventListener('click', startTimer);
        timerPauseBtn.addEventListener('click', pauseTimer);
        timerResetBtn.addEventListener('click', resetTimer);

        // ============================================
        // EXERCISE MODAL
        // ============================================
        let currentExercises = [];

        function addExerciseToModal(text, idx = null) {
            const exerciseDiv = document.createElement('div');
            exerciseDiv.className = 'flex items-center gap-2 bg-gray-700 rounded p-2';
            
            if (idx !== null) {
                exerciseDiv.innerHTML = `
                    <span class="text-white flex-1">${text}</span>
                    <button class="text-red-400 hover:text-red-300 text-sm" data-remove-exercise="${idx}">Remove</button>
                `;
                
                const removeBtn = exerciseDiv.querySelector('[data-remove-exercise]');
                removeBtn.addEventListener('click', () => {
                    currentExercises.splice(idx, 1);
                    exerciseDiv.remove();
                });
            } else {
                exerciseDiv.innerHTML = `
                    <span class="text-white flex-1 break-all">${text}</span>
                    <button class="text-red-400 hover:text-red-300 text-sm" data-remove-exercise-new>Remove</button>
                `;
                
                const removeBtn = exerciseDiv.querySelector('[data-remove-exercise-new]');
                removeBtn.addEventListener('click', () => {
                    exerciseDiv.remove();
                    const idx = Array.from(exerciseList.children).indexOf(exerciseDiv);
                    if (idx >= 0 && idx < currentExercises.length) {
                        currentExercises.splice(idx, 1);
                    }
                });
            }
            
            exerciseList.appendChild(exerciseDiv);
        }

        addExerciseBtn.addEventListener('click', () => {
            const text = exerciseInput.value.trim();
            if (!text) return;

            currentExercises.push({ text: text, completed: false });
            addExerciseToModal(text);
            exerciseInput.value = '';
        });

        exerciseInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addExerciseBtn.click();
            }
        });

        saveExercisesBtn.addEventListener('click', async () => {
            if (!currentTaskId || !currentUser) return;

            try {
                // Get existing exercises from the task
                const taskRef = doc(db, 'tasks', currentTaskId);
                const taskSnap = await getDoc(taskRef);
                
                if (taskSnap.exists()) {
                    const existingExercises = taskSnap.data().exercises || [];
                    // Merge: keep existing exercises, add new ones
                    const allExercises = [...existingExercises];
                    
                    // Add new exercises that aren't duplicates
                    currentExercises.forEach(newEx => {
                        if (!allExercises.some(ex => ex.text === newEx.text)) {
                            allExercises.push(newEx);
                        }
                    });

                    await updateDoc(taskRef, {
                        exercises: allExercises
                    });

                    exerciseModal.classList.add('hidden');
                    currentExercises = [];
                    exerciseList.innerHTML = '';
                    exerciseInput.value = '';
                    showToast('Exercises saved!');
                }
            } catch (error) {
                console.error('Error saving exercises:', error);
                showToast('Failed to save exercises.', 'error');
            }
        });

        closeExerciseModal.addEventListener('click', () => {
            exerciseModal.classList.add('hidden');
            currentExercises = [];
            exerciseList.innerHTML = '';
            exerciseInput.value = '';
        });

        // Close modal on outside click
        exerciseModal.addEventListener('click', (e) => {
            if (e.target === exerciseModal) {
                exerciseModal.classList.add('hidden');
                currentExercises = [];
                exerciseList.innerHTML = '';
                exerciseInput.value = '';
            }
        });

        // Initialize timer display
        updateTimerDisplay();
    </script>
</body>
</html>
